import admin from 'firebase-admin';

// Initialize Firebase Admin using the Secret Key you put in Vercel
if (!admin.apps.length) {
  admin.initializeApp({
    credential: admin.credential.cert(JSON.parse(process.env.FIREBASE_SERVICE_ACCOUNT)),
    databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com"
  });
}

const db = admin.database();

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).send('Method Not Allowed');

  const event = req.body;

  // 1. PAYMENT.SALE.COMPLETED triggers every time a monthly payment is successful
  // 2. BILLING.SUBSCRIPTION.CREATED triggers the very first time
  if (event.event_type === "PAYMENT.SALE.COMPLETED" || event.event_type === "BILLING.SUBSCRIPTION.CREATED") {
    
    // Retrieve the User UID we sent in the 'custom_id' field
    const uid = event.resource.custom_id || (event.resource.subscriber ? event.resource.subscriber.custom_id : null);

    if (uid) {
      // This adds 20 tokens to whatever they currently have
      await db.ref(`users/${uid}`).update({
        isPremium: true,
        tokens: admin.database.ServerValue.increment(20),
        lastBillingDate: new Date().toISOString()
      });
      
      console.log(`Successfully updated tokens for user: ${uid}`);
      return res.status(200).json({ message: 'Tokens Added' });
    }
  }

  // Tell PayPal we received the message so they stop resending it
  res.status(200).send('Webhook Received');
} 
