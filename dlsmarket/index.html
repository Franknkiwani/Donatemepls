<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DLS Market | AI Account Auditor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #020617; color: white; overflow-x: hidden; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .toast { transform: translateY(100px); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); opacity: 0; pointer-events: none; }
        .toast.show { transform: translateY(0); opacity: 1; pointer-events: auto; }
        .loader { border-top-color: #3b82f6; animation: spinner 0.8s linear infinite; }
        @keyframes spinner { to { transform: rotate(360deg); } }
        .value-glow { text-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
    </style>
</head>
<body class="min-h-screen">

    <div id="toast-container" class="fixed bottom-8 right-8 z-50 flex flex-col gap-3"></div>

    <nav class="p-6 flex justify-between items-center border-b border-white/5 sticky top-0 bg-slate-950/90 backdrop-blur-md z-40">
        <div class="text-2xl font-black tracking-tighter text-blue-500">DLS<span class="text-white">MARKET</span></div>
        <div class="flex gap-4">
            <button class="text-gray-400 hover:text-white font-bold text-sm transition">Marketplace</button>
            <button class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-xl font-bold transition-all hover:scale-105 active:scale-95 text-sm">Sign In</button>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto pt-20 px-6 text-center">
        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-500/10 border border-blue-500/20 text-blue-400 text-[10px] font-bold uppercase tracking-widest mb-8">
            <span class="relative flex h-2 w-2">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2 w-2 bg-blue-500"></span>
            </span>
            Gemini 1.5 Flash Vision Active
        </div>

        <h1 class="text-5xl md:text-7xl font-black mb-6 leading-tight tracking-tight">
            Verify Your <span class="text-blue-500">DLS Squad</span>
        </h1>
        <p class="text-gray-400 mb-12 max-w-lg mx-auto">Upload your team management screen. Our AI identifies legacy cards and calculates fair market value instantly.</p>
        
        <div id="drop-zone" class="glass rounded-[2.5rem] p-12 md:p-20 mb-12 border-2 border-dashed border-white/10 hover:border-blue-500/40 transition-all cursor-pointer group relative">
            <input type="file" id="file-input" class="hidden" accept="image/*">
            
            <div id="upload-content" class="transition-transform duration-300 group-hover:scale-105">
                <div class="w-20 h-20 bg-blue-600/20 rounded-2xl flex items-center justify-center mx-auto mb-6">
                    <svg class="w-10 h-10 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                </div>
                <h3 class="text-2xl font-extrabold mb-2 italic uppercase">Analyze Account</h3>
                <p class="text-gray-500 font-medium">Drag screenshot or click to browse</p>
            </div>

            <div id="loading-state" class="hidden">
                <div class="loader w-14 h-14 border-4 border-white/10 rounded-full mx-auto mb-6"></div>
                <p class="text-blue-400 font-black text-2xl animate-pulse tracking-tighter">AI AUDITING SQUAD...</p>
                <p class="text-gray-500 text-sm mt-2 italic">Identifying Legendary & Rare Players</p>
            </div>

            <div id="result-preview" class="hidden animate-in fade-in zoom-in duration-500">
                <div class="text-blue-500 font-black text-6xl mb-4 value-glow" id="preview-value">$0.00</div>
                <h4 class="text-white font-bold text-xl mb-4">Account Valuation Ready</h4>
                <div class="p-4 bg-white/5 rounded-xl text-gray-400 text-sm italic mb-6" id="preview-text"></div>
                <button id="view-report-btn" class="bg-blue-600 hover:bg-blue-700 w-full py-4 rounded-2xl font-black tracking-widest uppercase transition-all">View Full Verified Report</button>
            </div>
        </div>
    </main>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const uploadContent = document.getElementById('upload-content');
        const loadingState = document.getElementById('loading-state');
        const resultPreview = document.getElementById('result-preview');
        const previewValue = document.getElementById('preview-value');
        const previewText = document.getElementById('preview-text');
        const viewReportBtn = document.getElementById('view-report-btn');

        function notify(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const color = type === 'success' ? 'border-green-500 text-green-400' : 'border-red-500 text-red-400';
            
            toast.className = `glass border-l-4 ${color} px-6 py-4 rounded-xl font-bold shadow-2xl flex items-center gap-3 toast`;
            toast.innerHTML = `<span>${message}</span>`;
            
            container.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 400);
            }, 4500);
        }

        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => handleFile(e.target.files[0]);

        async function handleFile(file) {
            if (!file) return;
            
            uploadContent.classList.add('hidden');
            resultPreview.classList.add('hidden');
            loadingState.classList.remove('hidden');

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const base64Data = reader.result.split(',')[1];
                
                try {
                    const response = await fetch('/api/audit', {
                        method: 'POST',
                        body: JSON.stringify({ image: base64Data }),
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.reportId) {
                        loadingState.classList.add('hidden');
                        
                        // Extract value for preview using regex (looking for $)
                        const valueMatch = result.analysis.match(/\$\d+(\.\d+)?/);
                        const displayValue = valueMatch ? valueMatch[0] : "Check Report";
                        
                        previewValue.innerText = displayValue;
                        previewText.innerText = result.analysis.substring(0, 100) + "...";
                        resultPreview.classList.remove('hidden');
                        
                        notify("Valuation Complete!");
                        
                        viewReportBtn.onclick = () => {
                            window.location.href = `/report/${result.reportId}`;
                        };
                    } else {
                        throw new Error(result.error || "Gemini could not process the image.");
                    }
                } catch (err) {
                    notify(`Error: ${err.message}`, 'error');
                    loadingState.classList.add('hidden');
                    uploadContent.classList.remove('hidden');
                }
            };
        }
    </script>
</body>
</html>
