<!DOCTYPE html>
<html lang="en">
<head> 
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
<link rel="stylesheet" href="./style.css">
</head>
<body class="theme-dark">

    <div id="notify-box"></div>

    <nav class="glass-header flex justify-between items-center">
        <img src="https://i.imgur.com/BoVp6Td.png" class="h-9 w-auto" alt="Logo">
        <div class="flex items-center gap-3">
            <div id="user-tools" class="hidden flex items-center gap-3">
                <button onclick="openUpgradeModal()" class="bg-amber-500 text-black px-4 py-1.5 rounded-xl text-[10px] font-black uppercase tracking-widest">Upgrade</button>
                <div onclick="openProfile()" class="flex items-center gap-2 bg-white/5 p-1 pr-3 rounded-full cursor-pointer border border-white/10">
                    <div class="w-8 h-8 rounded-full bg-zinc-800 overflow-hidden flex-shrink-0">
                        <img id="header-pfp" class="w-full h-full object-cover hidden">
                        <span id="header-initial" class="flex items-center justify-center h-full text-[10px] font-bold">?</span>
                    </div>
                    <span id="header-handle" class="text-xs font-bold truncate-name">@User</span>
                    <img id="header-verified" src="https://img.icons8.com/color/48/verified-badge.png" class="w-4 h-4 hidden">
                </div>
            </div>
            <button id="login-btn" onclick="openAuthModal()" class="bg-white text-black px-5 py-1.5 rounded-full font-bold text-xs">Login</button>
        </div>
    </nav>

    <div id="auth-modal" class="fixed inset-0 z-[110] hidden bg-black/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-zinc-900 text-white w-full max-w-[380px] rounded-[32px] p-8 border border-white/10">
            <div class="flex gap-4 mb-6 border-b border-white/5">
                <button onclick="setAuthTab('login')" id="tab-login" class="pb-2 text-xs font-black uppercase border-b-2 border-amber-500">Login</button>
                <button onclick="setAuthTab('register')" id="tab-register" class="pb-2 text-xs font-black uppercase text-zinc-500">Register</button>
            </div>
            <div class="space-y-4">
                <div id="reg-name-field" class="hidden">
                    <input type="text" id="auth-username" class="w-full bg-white/5 border border-white/10 p-3 rounded-xl outline-none" placeholder="Username">
                </div>
                <input type="email" id="auth-email" class="w-full bg-white/5 border border-white/10 p-3 rounded-xl outline-none" placeholder="Email">
                <input type="password" id="auth-pass" class="w-full bg-white/5 border border-white/10 p-3 rounded-xl outline-none" placeholder="Password">
                <button onclick="handleAuthSubmit()" class="w-full bg-white text-black py-3 rounded-xl font-black uppercase text-xs">Continue</button>
                <div class="relative py-2 text-center"><span class="text-[10px] text-zinc-600 uppercase bg-zinc-900 px-2 relative z-10">or</span><hr class="absolute top-1/2 w-full border-white/5"></div>
                <button onclick="triggerGoogle()" class="w-full bg-zinc-800 py-3 rounded-xl font-bold text-xs flex items-center justify-center gap-2 border border-white/5">
                    <img src="https://www.google.com/favicon.ico" class="w-3 h-3"> Google
                </button>
            </div>
            <button onclick="closeAuthModal()" class="w-full mt-4 text-zinc-500 text-[10px] font-bold uppercase">Cancel</button>
        </div>
    </div>

    <div id="profile-modal" class="fixed inset-0 z-[100] hidden bg-black/90 flex items-center justify-center p-4">
    <div class="bg-zinc-900 text-white w-full max-w-sm rounded-[32px] p-8 border border-white/10 overflow-y-auto max-h-[90vh]">
        <div class="text-center mb-6">
            <div class="w-20 h-20 mx-auto rounded-full border-2 border-amber-500 p-1 mb-2">
                <img id="modal-preview-img" src="" class="w-full h-full object-cover rounded-full">
            </div>
            <h2 class="text-xl font-black uppercase italic">Profile</h2>
        </div>
        <div class="space-y-4">
            <div>
                <label class="text-[10px] font-bold text-zinc-500 uppercase">Page Theme</label>
                <div class="flex gap-2 mt-1">
                    <button id="btn-theme-dark" onclick="setTheme('theme-dark')" class="theme-btn w-full py-2 bg-zinc-800 rounded-lg text-[10px] font-bold uppercase">Dark</button>
                    <button id="btn-theme-light" onclick="setTheme('theme-light')" class="theme-btn w-full py-2 bg-white text-black rounded-lg text-[10px] font-bold uppercase">Light</button>
                    <button id="btn-theme-blue" onclick="setTheme('theme-blue')" class="theme-btn w-full py-2 bg-blue-900 rounded-lg text-[10px] font-bold uppercase">Blue</button>
                </div>
            </div>
            <div>
                <label class="text-[10px] font-bold text-zinc-500 uppercase">Username</label>
                <input type="text" id="username-input" class="bg-white/5 border border-white/10 w-full p-3 rounded-xl mt-1 outline-none" placeholder="Username">
            </div>
            <div>
                <label class="text-[10px] font-bold text-zinc-500 uppercase block mb-2">Avatars</label>
                <div class="grid grid-cols-4 gap-2" id="avatar-grid">
                    <div onclick="checkPremiumAndUpload()" class="relative aspect-square bg-zinc-800 rounded-xl flex items-center justify-center border-2 border-dashed border-zinc-700 hover:border-amber-500 cursor-pointer">
                        <i data-lucide="plus" class="w-4 h-4 text-zinc-500"></i>
                        <div class="premium-tag">PRO</div>
                        <input type="file" id="pfp-upload" class="hidden" accept="image/*">
                    </div>
                </div>
            </div>

            <div id="premium-management-zone" class="hidden border-t border-white/5 pt-4">
                <button onclick="window.open('https://www.paypal.com/myaccount/autopay/')" class="w-full bg-amber-500/10 border border-amber-500/20 text-amber-500 py-3 rounded-xl font-bold text-[10px] uppercase tracking-wider hover:bg-amber-500/20 transition-all">
                    Manage / Cancel PRO
                </button>
            </div>

            <button onclick="saveProfileChanges()" class="w-full bg-white text-black py-4 rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl">Update Profile</button>
            
            <div class="flex flex-col gap-2">
                <button onclick="handleLogout()" class="text-red-500 font-bold text-[10px] uppercase">Logout Account</button>
                <button onclick="closeProfile()" class="text-zinc-500 text-[10px] font-bold uppercase">Cancel</button>
            </div>
        </div>
    </div>
</div>
<div id="support-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-md hidden p-4">
    <div class="bg-zinc-950 border border-white/10 w-full max-w-lg rounded-[2.5rem] overflow-hidden flex flex-col shadow-[0_0_50px_rgba(37,99,235,0.15)] h-[75vh] md:h-[600px] transition-all transform">
        
        <div class="p-5 border-b border-white/5 flex justify-between items-center bg-white/5">
            <div class="flex items-center gap-3">
                <div class="relative">
                    <div class="w-10 h-10 rounded-2xl bg-blue-600 flex items-center justify-center shadow-[0_0_15px_rgba(37,99,235,0.4)]">
                        <i data-lucide="bot" class="w-6 h-6 text-white"></i>
                    </div>
                    <span class="absolute -bottom-1 -right-1 w-3.5 h-3.5 bg-emerald-500 border-2 border-zinc-950 rounded-full"></span>
                </div>
                <div>
                    <h3 class="text-white font-black text-xs uppercase tracking-widest">Grok Core</h3>
                    <p class="text-[8px] text-emerald-500 font-bold uppercase tracking-[0.2em]">Operational</p>
                </div>
            </div>
            <button onclick="closeSupportChat()" class="p-2 hover:bg-white/10 rounded-xl transition-all text-zinc-500 hover:text-white">
                <i data-lucide="minimize-2" class="w-4 h-4"></i>
            </button>
        </div>

        <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-6 scroll-smooth scrollbar-hide">
            <div class="flex gap-4 max-w-[90%]">
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-600/20 border border-blue-500/30 flex items-center justify-center">
                    <span class="text-[10px] font-black text-blue-400">G</span>
                </div>
                <div class="bg-white/5 border border-white/5 p-4 rounded-2xl rounded-tl-none">
                    <p class="text-[11px] text-zinc-300 leading-relaxed font-medium">Identity verified. I am Grok, your platform navigator. How can I assist your mission today?</p>
                </div>
            </div>
        </div>

        <div class="p-5 bg-zinc-900/20 border-t border-white/5">
            <div class="flex gap-2 items-center bg-white/5 border border-white/10 p-2 rounded-[1.5rem] focus-within:border-blue-500/50 transition-all">
                <input id="chat-input" type="text" placeholder="Inquire about missions, tokens, or security..." 
                       class="flex-1 bg-transparent border-none text-[11px] text-white px-3 focus:ring-0 placeholder:text-zinc-600 font-medium"
                       onkeydown="if(event.key === 'Enter') sendChatMessage()">
                <button onclick="sendChatMessage()" id="chat-send-btn" class="w-10 h-10 bg-blue-600 hover:bg-blue-500 rounded-xl flex items-center justify-center transition-all active:scale-90 shadow-lg shadow-blue-600/20">
                    <i data-lucide="arrow-up" class="w-5 h-5 text-white"></i>
                </button>
            </div>
            <p class="text-center text-[7px] text-zinc-600 mt-3 uppercase font-black tracking-widest">Powered by xAI Terminal</p>
        </div>
    </div>
</div>

<div id="explore-modal" class="hidden fixed inset-0 z-[100] bg-[#050505] backdrop-blur-3xl font-sans overflow-hidden">
    <div class="max-w-2xl mx-auto h-full flex flex-col">
        
        <div class="p-6 border-b border-white/5 flex justify-between items-center bg-black/50">
            <div>
                <h2 class="text-xl font-black italic tracking-tighter text-white uppercase">Network <span class="text-blue-500">Activity</span></h2>
                <div class="flex gap-4 mt-2">
                    <button onclick="switchHubView('live')" id="btn-live" class="text-[9px] font-black uppercase tracking-widest text-blue-500 border-b-2 border-blue-500 pb-1">Live Feed</button>
                    <button onclick="switchHubView('top-donors')" id="btn-donors" class="text-[9px] font-black uppercase tracking-widest text-zinc-500 pb-1">Top Donors</button>
                </div>
            </div>
            <button onclick="closeExploreModal()" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center border border-white/10 hover:bg-red-500/20 transition-all">
                <span class="text-white text-xs">‚úï</span>
            </button>
        </div>

        <div id="hub-content" class="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
            </div>

        <div id="user-hub-status" class="bg-zinc-900/90 border-t border-white/5 p-4 backdrop-blur-md"></div>
    </div>
</div>

<style>
    /* Clean scrollbar for the hub */
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #3b82f6; }
</style>

<div id="upgrade-modal" class="hidden fixed inset-0 z-[110] bg-black/95 flex items-center justify-center p-4">
    <div class="bg-zinc-900 text-white w-full max-w-2xl rounded-[40px] border border-white/10 overflow-hidden flex flex-col md:flex-row max-h-[90vh] overflow-y-auto custom-scrollbar">
        
        <div class="md:w-1/2 bg-gradient-to-br from-amber-400 to-orange-600 p-10 text-black flex flex-col justify-between sticky top-0">
            <div>
                <h2 class="text-5xl font-black uppercase italic leading-none">PRO</h2>
                <p class="font-bold text-[10px] uppercase tracking-widest mt-2">Elite Status</p>
                
                <div class="mt-8">
                    <div class="flex items-baseline gap-1">
                        <span class="text-4xl font-black">$5.49</span>
                        <span class="text-[10px] font-bold uppercase opacity-70">/ month</span>
                    </div>
                    <p class="text-[9px] font-bold uppercase tracking-tight opacity-80 mt-1">($4.99 + 10% processing fee)</p>
                </div>
            </div>
            
            <div class="bg-black/10 p-4 rounded-2xl flex items-center gap-3 mt-10">
                <div class="w-10 h-10 rounded-full bg-zinc-900 border-2 border-black overflow-hidden flex-shrink-0">
                    <img id="pro-pfp-preview" class="w-full h-full object-cover">
                </div>
                <div class="flex items-center min-w-0">
                    <span class="font-black text-sm truncate-name" id="pro-name-preview">User</span>
                    <img src="https://img.icons8.com/color/48/verified-badge.png" class="w-4 h-4 ml-1 flex-shrink-0">
                </div>
            </div>
        </div>

        <div class="md:w-1/2 p-10 bg-zinc-900">
            <h3 class="font-black uppercase mb-6 text-sm tracking-widest text-white">Elite Perks</h3>
            <ul class="space-y-4 mb-8 text-[11px] font-bold text-zinc-400">
                <li class="flex items-center gap-3"><i data-lucide="shield-check" class="text-amber-500 w-4 h-4"></i> Verified Blue Badge</li>
                <li class="flex items-center gap-3"><i data-lucide="coins" class="text-amber-500 w-4 h-4"></i> 20 Credits / Month</li>
                <li class="flex items-center gap-3"><i data-lucide="image" class="text-amber-500 w-4 h-4"></i> Custom Profile Uploads</li>
                <li class="flex items-center gap-3"><i data-lucide="user-cog" class="text-amber-500 w-4 h-4"></i> Unlimited Name Changes</li>
                <li class="flex items-center gap-3"><i data-lucide="headphones" class="text-amber-500 w-4 h-4"></i> Priority 24/7 Support</li>
            </ul>
            
            <div id="paypal-button-container-PRO" class="min-h-[150px]"></div>
            
            <button onclick="closeUpgradeModal()" class="w-full mt-4 text-[10px] font-black text-zinc-500 hover:text-white uppercase tracking-widest transition-colors">Close</button>
        </div>
    </div>
</div>

<div id="token-bar" class="hidden w-full backdrop-blur-xl border-b p-6" style="background-color: var(--card-bg); border-color: var(--border);">
    <div class="max-w-md mx-auto flex flex-col items-center">
        
        <span class="text-[10px] font-black uppercase tracking-[0.3em] text-zinc-500 mb-1">Current Balance</span>
        
        <div class="flex items-center gap-3 my-2">
            <i data-lucide="coins" class="w-6 h-6 text-amber-500"></i>
            <span id="token-count" class="text-5xl font-black tracking-tighter" style="color: var(--text-main) !important;">0</span>
        </div>
        
        <span class="text-[11px] font-bold text-amber-500/80 uppercase tracking-widest mb-6">Available Tokens</span>

        <div class="grid grid-cols-2 gap-3 w-full">
            <button onclick="openTokenModal()" class="flex items-center justify-center gap-2 py-3 bg-amber-500 hover:bg-amber-400 text-black rounded-xl transition-all active:scale-95 shadow-[0_0_20px_rgba(245,158,11,0.2)]">
                <i data-lucide="plus-circle" class="w-4 h-4"></i>
                <span class="text-xs font-black uppercase italic">Buy Tokens</span>
            </button>
            
            <button onclick="openWithdrawModal()" class="flex items-center justify-center gap-2 py-3 rounded-xl transition-all active:scale-95 border theme-light:bg-zinc-200 theme-light:text-black theme-light:border-black/10 theme-dark:bg-zinc-800 theme-dark:text-white theme-dark:border-white/5">
                <i data-lucide="arrow-up-right" class="w-4 h-4 text-zinc-400"></i>
                <span class="text-xs font-black uppercase italic">Withdraw</span>
            </button>
        </div>
    </div>
</div>


<div id="token-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
    <div class="border w-full max-w-md rounded-3xl overflow-hidden shadow-2xl flex flex-col max-h-[90vh]" style="background-color: var(--card-bg); border-color: var(--border); color: var(--text-main);">
        
        <div class="p-6 border-b flex justify-between items-center flex-shrink-0" style="background-color: rgba(0,0,0,0.05); border-color: var(--border);">
            <div>
                <h2 class="text-xl font-black italic uppercase tracking-tighter" style="color: var(--text-main);">Refill Tokens</h2>
                <p class="text-[10px] text-zinc-500 font-bold uppercase tracking-widest">Select a one-time credit pack</p>
            </div>
            <button onclick="closeTokenModal()" class="w-8 h-8 flex items-center justify-center rounded-full bg-white/5 text-zinc-400 hover:text-white transition-colors">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
        </div>

        <div class="p-6 overflow-y-auto custom-scrollbar">
            <div class="grid grid-cols-2 gap-3 mb-6">
                <button onclick="selectPack(this, 3, 30)" class="pack-option group flex flex-col items-center p-4 border rounded-2xl transition-all active:scale-95" style="background-color: var(--input-bg); border-color: var(--border);">
                    <span class="text-[10px] font-black text-zinc-500 uppercase mb-1">Starter</span>
                    <span class="text-2xl font-black" style="color: var(--text-main);">30</span>
                    <span class="text-[10px] font-bold text-amber-500 uppercase tracking-widest mb-3">Tokens</span>
                    <div class="w-full py-2 bg-amber-500 text-black rounded-lg text-xs font-black transition-colors">$3.00</div>
                </button>

                <button onclick="selectPack(this, 5, 50)" class="pack-option group flex flex-col items-center p-4 border rounded-2xl transition-all active:scale-95" style="background-color: var(--input-bg); border-color: var(--border);">
                    <span class="text-[10px] font-black text-zinc-500 uppercase mb-1">Popular</span>
                    <span class="text-2xl font-black" style="color: var(--text-main);">50</span>
                    <span class="text-[10px] font-bold text-amber-500 uppercase tracking-widest mb-3">Tokens</span>
                    <div class="w-full py-2 bg-amber-500 text-black rounded-lg text-xs font-black transition-colors">$5.00</div>
                </button>

                <button onclick="selectPack(this, 10, 100)" class="pack-option group flex flex-col items-center p-4 border rounded-2xl transition-all active:scale-95" style="background-color: var(--input-bg); border-color: var(--border);">
                    <span class="text-[10px] font-black text-zinc-500 uppercase mb-1">Pro</span>
                    <span class="text-2xl font-black" style="color: var(--text-main);">100</span>
                    <span class="text-[10px] font-bold text-amber-500 uppercase tracking-widest mb-3">Tokens</span>
                    <div class="w-full py-2 bg-amber-500 text-black rounded-lg text-xs font-black transition-colors">$10.00</div>
                </button>

                <button onclick="selectPack(this, 25, 250)" class="pack-option group flex flex-col items-center p-4 border rounded-2xl transition-all active:scale-95 relative overflow-hidden" style="background-color: var(--input-bg); border-color: var(--border);">
                    <div class="absolute top-0 right-0 bg-amber-500 text-[8px] font-black px-2 py-0.5 text-black uppercase italic z-10">Best Value</div>
                    <span class="text-[10px] font-black text-zinc-500 uppercase mb-1">Whale</span>
                    <span class="text-2xl font-black" style="color: var(--text-main);">250</span>
                    <span class="text-[10px] font-bold text-amber-500 uppercase tracking-widest mb-3">Tokens</span>
                    <div class="w-full py-2 bg-amber-500 text-black rounded-lg text-xs font-black transition-colors">$25.00</div>
                </button>
            </div>

            <div id="paypal-tokens-container" class="min-h-[150px] pb-4"></div>
        </div>
    </div>
</div>

<div id="withdraw-modal" class="hidden fixed inset-0 z-[110] flex items-center justify-center bg-black/90 backdrop-blur-md p-4">
    <div class="border w-full max-w-md rounded-[32px] overflow-hidden shadow-2xl flex flex-col max-h-[90vh]" 
         style="background-color: var(--card-bg); border-color: var(--border); color: var(--text-main);">
        
        <div class="p-8 pb-4 text-center relative">
            <div class="w-16 h-16 bg-emerald-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-emerald-500/20">
                <i data-lucide="landmark" class="w-8 h-8 text-emerald-500"></i>
            </div>
            <h2 class="text-2xl font-black uppercase italic tracking-tighter" style="color: var(--text-main);">Cash Out</h2>
            <p class="text-[10px] text-zinc-500 font-bold uppercase tracking-[0.2em]">Secure PayPal Payouts</p>
        </div>

        <div class="flex justify-around py-4 border-y" style="background-color: rgba(0,0,0,0.05); border-color: var(--border);">
            <div class="text-center">
                <span class="block text-[8px] font-black text-zinc-500 uppercase tracking-widest">Total Paid</span>
                <span id="total-withdrawn" class="text-sm font-black text-emerald-500">$0.00</span>
            </div>
            <div class="w-px h-8" style="background-color: var(--border);"></div>
            <div class="text-center">
                <span class="block text-[8px] font-black text-zinc-500 uppercase tracking-widest">Pending</span>
                <span id="pending-count" class="text-sm font-black text-amber-500">0</span>
            </div>
        </div>

        <div class="p-8 overflow-y-auto custom-scrollbar space-y-6">
            <div class="space-y-2">
                <div class="flex justify-between items-end">
                    <label class="text-[10px] font-black text-zinc-400 uppercase tracking-widest">PayPal Recipient</label>
                    <span class="text-[9px] text-emerald-500 font-bold uppercase">Verified Gateway</span>
                </div>
                <div class="relative">
                    <i data-lucide="mail" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-600"></i>
                    <input type="email" id="withdraw-email" 
                           class="w-full border p-4 pl-12 rounded-2xl outline-none focus:border-emerald-500/50 transition-all text-sm font-bold" 
                           style="background-color: var(--input-bg); border-color: var(--border); color: var(--text-main);"
                           placeholder="paypal@example.com">
                </div>
            </div>

            <div class="space-y-2">
                <label class="text-[10px] font-black text-zinc-400 uppercase tracking-widest">Token Amount</label>
                <div class="relative">
                    <i data-lucide="coins" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-amber-500"></i>
                    <input type="number" id="withdraw-amount" 
                           class="w-full border p-4 pl-12 rounded-2xl outline-none focus:border-amber-500/50 transition-all text-sm font-bold" 
                           style="background-color: var(--input-bg); border-color: var(--border); color: var(--text-main);"
                           placeholder="Min. 50">
                </div>
            </div>

            <div class="rounded-2xl p-4 border space-y-3" style="background-color: rgba(0,0,0,0.1); border-color: var(--border);">
                <div class="flex justify-between items-center text-[10px] font-bold uppercase tracking-widest">
                    <span class="text-zinc-500">Gross Value</span>
                    <span id="calc-gross" style="color: var(--text-main);">$0.00</span>
                </div>
                <div class="flex justify-between items-center text-[10px] font-bold uppercase tracking-widest">
                    <span class="text-zinc-500">Platform Fee (30%)</span>
                    <span id="calc-fee" class="text-red-500">-$0.00</span>
                </div>
                <div class="h-px" style="background-color: var(--border);"></div>
                <div class="flex justify-between items-center font-black uppercase tracking-tighter italic">
                    <span class="text-zinc-400 text-xs">Net Payout</span>
                    <span id="calc-net" class="text-emerald-500 text-xl font-black">$0.00</span>
                </div>
            </div>

            <button onclick="handleWithdrawSubmit()" 
                    class="w-full bg-white text-black py-4 rounded-2xl font-black text-xs uppercase tracking-[0.2em] shadow-xl active:scale-95 transition-all theme-light:bg-zinc-900 theme-light:text-white">
                Confirm Payout
            </button>

            <div id="payout-history-container" class="hidden border-t pt-4" style="border-color: var(--border);">
                <span class="text-[9px] font-black text-zinc-600 uppercase tracking-widest block mb-3 text-center">Recent Activity</span>
                <div id="payout-history-list" class="space-y-2"></div>
            </div>

            <button onclick="closeWithdrawModal()" class="w-full text-zinc-600 text-[10px] font-black uppercase tracking-[0.2em] hover:text-white transition-colors">
                Cancel Request
            </button>
        </div>
    </div>
</div>
<div class="max-w-7xl mx-auto p-4 md:p-8">
    
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-10">
        <div>
            <h2 class="text-3xl font-black uppercase italic tracking-tighter" style="color: var(--text-main);">Discovery</h2>
            <p class="text-[10px] text-zinc-500 font-bold uppercase tracking-widest">Support creators or contribute to foundations</p>
        </div>

        <div class="flex-1 max-w-md w-full">
            <div class="relative">
                <input type="text" id="user-search-input" oninput="searchUser()" 
                       placeholder="SEARCH @USER, #TAGS, OR CAMPAIGNS..." 
                       class="w-full bg-white/5 border border-white/10 rounded-2xl px-5 py-4 text-xs font-black uppercase tracking-widest text-white focus:outline-none focus:border-pink-500/50 transition-all">
                <span class="absolute right-4 top-1/2 -translate-y-1/2 text-[8px] font-black text-zinc-700 uppercase italic">Global</span>
            </div>
        </div>
        
        <div class="flex bg-zinc-900/50 p-1 rounded-2xl border border-white/5" style="background-color: var(--input-bg);">
            <button onclick="switchView('campaigns')" id="tab-campaigns" class="px-6 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all bg-white text-black shadow-lg">Campaigns</button>
            <button onclick="switchView('community')" id="tab-community" class="px-6 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all text-zinc-500 hover:text-white">User Tipping</button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <div id="view-campaigns" class="lg:col-span-7 space-y-6">
            <div class="flex items-center justify-between mb-4">
                <span class="text-[10px] font-black text-amber-500 uppercase tracking-[0.2em]">Active Goals</span>
                <button onclick="openCreateCampaign()" class="text-[9px] font-black text-zinc-500 hover:text-white uppercase transition-all">+ New Campaign</button>
            </div>
            <div id="campaign-grid" class="grid grid-cols-1 gap-6"></div>
        </div>

        <div id="view-community" class="lg:col-span-5 space-y-6">
            <div class="flex items-center justify-between mb-4">
                <span class="text-[10px] font-black text-emerald-500 uppercase tracking-[0.2em]">Online Community</span>
            </div>
            <div id="user-feed-grid" class="grid grid-cols-1 gap-4"></div>
        </div>
    </div>
</div>

<div id="modern-donate-modal" class="fixed inset-0 z-[999] hidden flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
    <div class="bg-zinc-900 border border-white/10 w-full max-w-sm rounded-[32px] overflow-hidden shadow-2xl">
        <div class="p-8 text-center">
            <img id="donate-target-img" src="" class="w-20 h-20 rounded-full mx-auto border-4 border-emerald-500 shadow-lg mb-4 object-cover">
            <h2 id="donate-target-name-display" class="text-xl font-black uppercase text-white">@User</h2>
            <p class="text-zinc-500 text-[10px] font-bold uppercase tracking-widest mt-1">Support this member</p>

            <div id="stats-glass-card" class="mt-6 p-4 rounded-2xl border border-white/10 bg-white/5 backdrop-blur-md relative overflow-hidden">
                <div class="flex justify-around items-center">
                    <div class="text-center">
                        <span class="block text-[8px] font-black text-zinc-500 uppercase tracking-widest mb-1">Total Raised</span>
                        <span id="stat-raised-val" class="text-emerald-500 font-black text-sm">0</span>
                    </div>
                    <div class="w-px h-6 bg-white/10"></div>
                    <div class="text-center">
                        <span class="block text-[8px] font-black text-zinc-500 uppercase tracking-widest mb-1">Supporters</span>
                        <span id="stat-donors-val" class="text-amber-500 font-black text-sm">0</span>
                    </div>
                </div>

                <div id="stats-premium-lock" class="hidden absolute inset-0 bg-black/40 backdrop-blur-md flex items-center justify-center">
                    <div class="bg-amber-500 text-black px-3 py-1 rounded-full text-[8px] font-black uppercase tracking-tighter flex items-center gap-1 shadow-lg shadow-amber-500/20">
                        <i data-lucide="crown" class="w-2.5 h-2.5"></i> Premium Only
                    </div>
                </div>
            </div>
            <div class="mt-8 space-y-4">
                <div class="relative">
                    <input type="number" id="donate-input-amount" placeholder="0.00" 
                           class="w-full bg-white/5 border border-white/10 rounded-2xl px-6 py-4 text-center text-2xl font-black text-white focus:outline-none focus:border-emerald-500 transition-all">
                    <span class="absolute right-6 top-1/2 -translate-y-1/2 text-[10px] font-black text-zinc-600 uppercase">Tokens</span>
                </div>
                
                <div id="fee-notice"></div>

                <button id="confirm-donation-btn" class="w-full py-4 bg-emerald-500 text-black font-black uppercase rounded-2xl hover:bg-emerald-400 transition-all active:scale-95 shadow-lg shadow-emerald-500/20">
                    Confirm Transfer
                </button>
                
                <button onclick="closeDonateModal()" class="w-full py-4 text-zinc-500 text-[10px] font-black uppercase tracking-widest hover:text-white transition-all">
                    Cancel & Close
                </button>
            </div>
        </div>
    </div>
</div>

<div id="donation-success-modal" class="hidden fixed inset-0 z-[1000] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md">
    <div class="bg-zinc-900 border border-white/10 w-full max-w-xs rounded-[40px] overflow-hidden shadow-2xl transform transition-all scale-100">
        <div class="bg-emerald-500 p-8 text-center relative">
            <div class="absolute -bottom-6 left-1/2 -translate-x-1/2 w-12 h-12 bg-zinc-900 rounded-full flex items-center justify-center border-4 border-emerald-500">
                <i data-lucide="check" class="text-emerald-500 w-6 h-6"></i>
            </div>
            <h2 class="text-black text-2xl font-black uppercase italic tracking-tighter">Sent!</h2>
        </div>
        
        <div class="p-8 pt-10 text-center">
            <p class="text-[10px] text-zinc-500 font-bold uppercase tracking-widest mb-1">Transaction Complete</p>
            <div class="flex items-center justify-center gap-2 mb-6">
                <span id="success-net-amount" class="text-4xl font-black text-white">0</span>
                <span class="text-xs font-bold text-emerald-500 uppercase tracking-widest mt-2">Tokens</span>
            </div>

            <div class="space-y-3 border-t border-white/5 pt-6 mb-8">
                <div class="flex justify-between text-[10px] font-bold uppercase tracking-widest">
                    <span class="text-zinc-500">Total Charged</span>
                    <span id="success-gross-amount" class="text-white">0</span>
                </div>
                <div class="flex justify-between text-[10px] font-bold uppercase tracking-widest">
                    <span class="text-zinc-500">Platform Fee</span>
                    <span id="success-fee-amount" class="text-amber-500">0</span>
                </div>
            </div>

            <button onclick="closeSuccessModal()" class="w-full py-4 bg-white/5 border border-white/10 text-white rounded-2xl font-black text-[10px] uppercase tracking-[0.2em] hover:bg-white/10 transition-all">
                Back to Discovery
            </button>
        </div>
    </div>
</div>
<div id="error-modal" class="hidden fixed inset-0 z-[1200] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md">
    <div class="bg-zinc-900 border border-white/10 w-full max-w-xs rounded-[40px] overflow-hidden shadow-2xl">
        <div class="bg-red-500 p-8 text-center relative">
            <div class="absolute -bottom-6 left-1/2 -translate-x-1/2 w-12 h-12 bg-zinc-900 rounded-full flex items-center justify-center border-4 border-red-500">
                <i data-lucide="shield-alert" class="text-red-500 w-6 h-6"></i>
            </div>
            <h2 class="text-white text-xl font-black uppercase italic tracking-tighter">Action Denied</h2>
        </div>
        
        <div class="p-8 pt-10 text-center">
            <p class="text-[10px] text-zinc-500 font-bold uppercase tracking-widest mb-2">Security Limit Reached</p>
            <p id="error-modal-msg" class="text-white text-sm font-bold leading-relaxed mb-8 px-2">
                You can only withdraw earned tokens.
            </p>

            <button onclick="closeErrorModal()" class="w-full py-4 bg-white/5 border border-white/10 text-white rounded-2xl font-black text-[10px] uppercase tracking-[0.2em] hover:bg-white/20 transition-all">
                I Understand
            </button>
        </div>
    </div>
</div>

<div id="withdraw-success-modal" class="hidden fixed inset-0 z-[1200] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md">
    <div class="bg-zinc-900 border border-white/10 w-full max-w-xs rounded-[40px] overflow-hidden shadow-2xl">
        <div class="bg-emerald-500 p-8 text-center relative">
            <div class="absolute -bottom-6 left-1/2 -translate-x-1/2 w-12 h-12 bg-zinc-900 rounded-full flex items-center justify-center border-4 border-emerald-500">
                <i data-lucide="send" class="text-emerald-500 w-6 h-6"></i>
            </div>
            <h2 class="text-black text-xl font-black uppercase italic tracking-tighter">Request Sent</h2>
        </div>
        
        <div class="p-8 pt-10 text-center">
            <p class="text-[10px] text-zinc-500 font-bold uppercase tracking-widest mb-1">Estimated Arrival: 24h</p>
            <div class="flex items-center justify-center gap-2 mb-6">
                <span id="payout-success-usd" class="text-4xl font-black text-white">$0.00</span>
            </div>

            <p class="text-[10px] text-zinc-400 font-bold leading-relaxed mb-8 px-4 uppercase tracking-tighter">
                Funds are being sent to your PayPal email. Check your dashboard for updates.
            </p>

            <button onclick="closeWithdrawSuccess()" class="w-full py-4 bg-white/5 border border-white/10 text-white rounded-2xl font-black text-[10px] uppercase tracking-[0.2em] hover:bg-white/10 transition-all">
                Perfect, Thanks!
            </button>
        </div>
    </div>
</div>
<div id="admin-verify-modal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-[200] p-4 backdrop-blur-sm">
    <div class="bg-[#1a1a1a] border border-yellow-500/30 rounded-2xl p-6 w-full max-w-sm shadow-2xl">
        <div class="flex items-center gap-3 mb-2 text-yellow-500">
            <i data-lucide="shield-lock"></i>
            <h3 class="text-xl font-bold">Vault Access</h3>
        </div>
        <p class="text-gray-400 text-sm mb-6">Verification required to move platform funds.</p>
        
        <input type="password" id="admin-secret-field" 
               class="w-full bg-black border border-white/10 rounded-xl p-3 text-white mb-6 focus:border-yellow-500 outline-none"
               placeholder="Enter Vercel Token...">
        
        <div class="flex gap-3">
            <button id="cancel-verify-btn" class="flex-1 px-4 py-3 rounded-xl bg-white/5 text-white hover:bg-white/10 transition">Cancel</button>
            <button id="confirm-verify-btn" class="flex-1 px-4 py-3 rounded-xl bg-yellow-600 text-white font-bold hover:bg-yellow-500 transition">Verify</button>
        </div>
    </div>
</div>
<nav class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[92%] max-w-md z-[50]">
    <div class="bg-black/80 backdrop-blur-2xl border border-white/10 p-2 rounded-[2.5rem] flex items-center justify-around shadow-[0_20px_50px_rgba(0,0,0,0.5)]">
        
        <button onclick="openSupportChat()" class="nav-item flex flex-col items-center gap-1 p-2 text-gray-400 hover:text-white transition-all">
            <i data-lucide="message-circle" class="w-5 h-5"></i>
            <span class="text-[9px] font-bold uppercase tracking-widest">Support</span>
        </button>

        <button onclick="openExploreModal()" class="nav-item flex flex-col items-center gap-1 p-2 text-gray-400 hover:text-white transition-all">
            <i data-lucide="search" class="w-5 h-5"></i>
            <span class="text-[9px] font-bold uppercase tracking-widest">Explore</span>
        </button>

        <div class="relative flex justify-center items-center px-2">
            <div class="absolute -inset-2 bg-blue-600/20 blur-xl rounded-full pulse-slow"></div>
            <button onclick="openCreateCampaignModal()" class="relative -top-6 bg-gradient-to-br from-blue-500 to-blue-700 p-4 rounded-2xl shadow-lg shadow-blue-900/40 border-[6px] border-[#0a0a0a] text-white transform hover:scale-110 active:scale-90 transition-all">
                <i data-lucide="plus" class="w-8 h-8 stroke-[3px]"></i>
            </button>
        </div>

        <button onclick="openWalletModal()" class="nav-item flex flex-col items-center gap-1 p-2 text-gray-400 hover:text-white transition-all">
            <i data-lucide="wallet" class="w-5 h-5"></i>
            <span class="text-[9px] font-bold uppercase tracking-widest">Wallet</span>
        </button>

        <button onclick="openAccountModal()" class="nav-item flex flex-col items-center gap-1 p-2 text-gray-400 hover:text-white transition-all">
            <i data-lucide="user" class="w-5 h-5"></i>
            <span class="text-[9px] font-bold uppercase tracking-widest">Account</span>
        </button>
    </div>
</nav>



<div id="campaign-studio-modal" class="fixed inset-0 z-[200] hidden bg-black/98 backdrop-blur-3xl overflow-y-auto selection:bg-blue-500/30">
    <div class="max-w-5xl mx-auto p-6 md:p-12 text-white">
        <div class="flex justify-between items-center mb-16">
            <div class="space-y-1">
                <h1 class="text-5xl font-black italic uppercase tracking-tighter leading-none">Campaign Studio</h1>
                <p class="text-zinc-500 text-[10px] font-black uppercase tracking-[0.4em] ml-1">Forge your reach ‚Ä¢ Scale your vision</p>
            </div>
            <button onclick="closeStudio()" class="group w-14 h-14 rounded-2xl bg-white/5 flex items-center justify-center hover:bg-red-500/20 transition-all border border-white/5">
                <span class="group-hover:rotate-90 transition-transform duration-300 text-2xl">‚úï</span>
            </button>
        </div>

        <div class="flex gap-2 mb-12 bg-zinc-900/50 p-2 rounded-2xl border border-white/5 w-fit">
            <button onclick="switchStudioTab('create')" id="tab-btn-create" class="px-10 py-4 rounded-xl text-[11px] font-black uppercase tracking-widest bg-blue-600 text-white shadow-[0_0_30px_rgba(37,99,235,0.3)]">Create</button>
            <button onclick="switchStudioTab('manage')" id="tab-btn-manage" class="px-10 py-4 rounded-xl text-[11px] font-black uppercase tracking-widest text-zinc-500 hover:text-white transition-all">My Campaigns</button>
        </div>

        <div id="studio-create-view" class="grid grid-cols-1 lg:grid-cols-12 gap-12 animate-in fade-in slide-in-from-bottom-8 duration-700">
            <div class="lg:col-span-7 space-y-10">
                <div class="group relative">
                    <input type="text" id="cp-title" required placeholder=" " class="peer w-full bg-transparent border-b-2 border-zinc-800 p-4 pl-0 text-3xl font-bold outline-none focus:border-blue-500 transition-all">
                    <label class="absolute left-0 top-4 text-zinc-500 text-2xl font-bold pointer-events-none transition-all peer-focus:-top-6 peer-focus:text-xs peer-focus:text-blue-500 peer-[:not(:placeholder-shown)]:-top-6 peer-[:not(:placeholder-shown)]:text-xs uppercase italic">Campaign Heading</label>
                </div>

                <div class="relative bg-zinc-900/40 rounded-[2rem] border border-white/5 p-6 focus-within:border-blue-500/50 transition-all">
                    <div class="flex justify-between items-center mb-4">
                        <label class="text-[10px] font-black text-zinc-500 uppercase tracking-widest">The Story</label>
                        <button onclick="generateAIContent()" id="ai-gen-btn" class="flex items-center gap-2 px-4 py-1.5 rounded-full bg-gradient-to-r from-purple-600 to-blue-600 text-[9px] font-black uppercase text-white hover:scale-105 transition-all">
                            <span>‚ú® AI Auto-Write</span>
                        </button>
                    </div>
                    <textarea id="cp-desc" rows="6" placeholder="Describe your mission..." class="w-full bg-transparent outline-none text-zinc-300 font-medium leading-relaxed resize-none"></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-zinc-900/50 p-6 rounded-[2rem] border border-white/5 flex items-center justify-between">
                        <div>
                            <h4 class="text-[9px] font-black text-blue-500 uppercase tracking-widest mb-1">Target Goal</h4>
                            <input type="number" id="cp-goal" placeholder="0" class="bg-transparent w-full text-xl font-black outline-none">
                        </div>
                        <span class="text-zinc-600 font-black text-[10px] uppercase">Tokens</span>
                    </div>

                    <div class="bg-zinc-900/50 p-6 rounded-[2rem] border border-white/5 flex items-center justify-between">
                        <div>
                            <h4 class="text-[9px] font-black text-zinc-500 uppercase tracking-widest mb-1">Visibility</h4>
                            <select id="cp-visibility" onchange="checkPremiumVisibility(this)" class="bg-transparent text-white font-black text-sm outline-none cursor-pointer appearance-none">
                                <option value="public" class="bg-zinc-900">üåç Public Feed</option>
                                <option value="private" class="bg-zinc-900">üîí Private (PRO)</option>
                            </select>
                        </div>
                        <div id="premium-lock-icon" class="w-8 h-8 rounded-full bg-blue-500/10 flex items-center justify-center">
                            <span class="text-blue-500 text-[10px]">üåê</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-zinc-900/50 p-6 rounded-[2rem] border border-white/5">
                        <h4 class="text-[9px] font-black text-zinc-500 uppercase tracking-widest mb-2">Category</h4>
                        <select id="cp-category" class="w-full bg-transparent font-bold text-sm outline-none">
                            <option value="General" class="bg-zinc-900">General</option>
                            <option value="Medical" class="bg-zinc-900">Medical</option>
                            <option value="Crisis" class="bg-zinc-900">Crisis</option>
                        </select>
                    </div>
                    <div class="bg-zinc-900/50 p-6 rounded-[2rem] border border-white/5">
                        <h4 class="text-[9px] font-black text-zinc-500 uppercase tracking-widest mb-2">Duration</h4>
                        <select id="cp-duration" class="w-full bg-transparent font-bold text-sm outline-none">
                            <option value="7" class="bg-zinc-900">7 Days</option>
                            <option value="30" class="bg-zinc-900">30 Days</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-5 space-y-8">
                <div class="space-y-4">
                    <div class="relative aspect-video rounded-[2.5rem] bg-zinc-900 overflow-hidden border border-white/10 shadow-2xl">
                        <img id="cp-preview-img" src="https://images.hive.blog/p/NTy4GV6ooFRmaCXZ8UYgPhoud1kjiNX8QokLEZtbBKLuLWQ9yt7K3o4MTgeicR2JF9fLXTD4sRt27d8vG5aiRCoDjrf24e3CMD5msbfdUbX1MzSVDjCMsn17K2A775iLEM4LvckBAcG8CU92RjLTtvsDiS6HzSxeXpvTZjux?format=match&mode=fit" class="w-full h-full object-cover">
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="flex gap-2 p-2 bg-white/5 rounded-2xl border border-white/5">
                            <img onclick="selectPreset(this.src, this)" src="https://images.hive.blog/p/NTy4GV6ooFRmaCXZ8UYgPhoud1kjiNX8QokLEZtbBKLuLWQ9yt7K3o4MTgeicR2JF9fLXTD4sRt27d8vG5aiRCoDjrf24e3CMD5msbfdUbX1MzSVDjCMsn17K2A775iLEM4LvckBAcG8CU92RjLTtvsDiS6HzSxeXpvTZjux?format=match&mode=fit" class="preset-option w-10 h-10 rounded-lg border-2 border-blue-500 cursor-pointer object-cover">
                        </div>
                        <button id="upload-trigger-btn" onclick="document.getElementById('cp-image-input').click()" class="flex-1 py-4 bg-white/5 text-[9px] font-black uppercase rounded-2xl border border-white/5 hover:bg-white/10 tracking-widest">üì∏ Custom Upload</button>
                        <input type="file" id="cp-image-input" class="hidden" accept="image/*" onchange="uploadCampaignImage(event)">
                    </div>
                </div>

                <div class="p-8 bg-blue-600/5 rounded-[3rem] border border-blue-500/20 space-y-6">
                    <div class="flex justify-between items-center">
                        <label class="text-[10px] font-black text-blue-500 uppercase tracking-widest italic">Reach Fuel (1 Token = 3 Views)</label>
                        <input type="number" id="reach-input-manual" value="0" class="bg-blue-500/10 border border-blue-500/30 rounded-xl px-3 py-2 text-lg w-28 text-center font-black outline-none" oninput="updateReachMath(this.value)">
                    </div>
                    <input type="range" id="reach-slider" min="0" max="100000" step="100" value="0" class="w-full accent-blue-500 h-1.5 bg-zinc-800 rounded-full appearance-none cursor-pointer" oninput="updateReachMath(this.value)">
                    <div class="flex justify-between pt-2">
                        <div>
                            <p class="text-[8px] font-black text-zinc-600 uppercase mb-1">Potential Reach</p>
                            <h3 id="reach-display" class="text-3xl font-black tracking-tighter">0 <span class="text-xs text-zinc-500">Reach</span></h3>
                        </div>
                        <div class="text-right">
                            <p class="text-[8px] font-black text-zinc-600 uppercase mb-1">Cost</p>
                            <h3 id="cost-display" class="text-3xl font-black text-blue-500 tracking-tighter">0 <span class="text-xs text-zinc-400">Tokens</span></h3>
                        </div>
                    </div>
                </div>
                <button onclick="createNewCampaign()" class="w-full py-6 bg-blue-600 text-white rounded-[2rem] font-black uppercase tracking-[0.4em] hover:bg-blue-500 transition-all shadow-[0_20px_50px_rgba(37,99,235,0.3)]">Launch Mission</button>
            </div>
        </div>

        <div id="studio-manage-view" class="hidden animate-in fade-in zoom-in-95 duration-500">
            <div id="my-campaigns-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
    </div>
</div>

<div id="boost-modal" class="fixed inset-0 z-[300] hidden bg-black/95 backdrop-blur-xl flex items-center justify-center p-6 text-white">
    <div class="bg-zinc-900 border border-white/10 p-10 rounded-[40px] max-w-sm w-full space-y-8 shadow-2xl">
        <div class="text-center">
            <h3 class="text-2xl font-black uppercase italic tracking-tighter">Refuel Mission</h3>
            <p class="text-zinc-500 text-[9px] font-black uppercase tracking-[0.3em] mt-2">1 Token = 3 Guaranteed Views</p>
        </div>
        <div class="space-y-4">
            <input type="number" id="boost-modal-input" placeholder="Tokens" class="w-full bg-black/50 border border-white/10 rounded-3xl py-5 px-6 text-3xl font-black text-center outline-none focus:border-blue-500 transition-all" oninput="updateBoostLiveMath(this.value)">
            <div class="flex justify-between items-center bg-blue-600/5 p-5 rounded-3xl border border-blue-500/20">
                <span class="text-[9px] font-black text-blue-500 uppercase">New Reach</span>
                <span id="boost-live-reach" class="text-xl font-black italic">0 Views</span>
            </div>
        </div>
        <div class="flex flex-col gap-2">
            <button id="confirm-boost-btn" class="w-full py-5 bg-blue-600 rounded-[2rem] font-black uppercase text-[11px] tracking-widest shadow-xl shadow-blue-600/20">Confirm Boost</button>
            <button onclick="closeBoostModal()" class="w-full py-4 text-zinc-600 font-black uppercase text-[9px] tracking-widest">Cancel</button>
        </div>
    </div>
</div>

<div id="studio-success-modal" class="fixed inset-0 z-[300] hidden flex items-center justify-center p-4 bg-black/90 backdrop-blur-xl">
    <div class="bg-zinc-900 border border-white/10 w-full max-w-sm rounded-[32px] p-8 text-center animate-in zoom-in-95 duration-300">
        <div class="w-20 h-20 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-[0_0_40px_rgba(37,99,235,0.4)]">
            <span class="text-3xl text-white">üöÄ</span>
        </div>
        <h2 id="studio-success-title" class="text-2xl font-black text-white uppercase italic tracking-tighter mb-2">Mission Launched</h2>
        <p id="studio-success-msg" class="text-zinc-400 text-xs font-medium leading-relaxed mb-8 px-4">Your campaign is now live in the global discovery feed.</p>
        <button onclick="closeStudioSuccess()" class="w-full py-4 bg-white text-black rounded-2xl font-black uppercase text-[10px] tracking-widest hover:bg-blue-500 hover:text-white transition-all">Continue</button>
    </div>
</div>
<div id="boost-modal" class="fixed inset-0 z-[300] hidden flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl">
    <div class="bg-zinc-900 border border-white/10 w-full max-w-sm rounded-[2.5rem] p-8 space-y-6 animate-in zoom-in-95 duration-300">
        <div class="text-center">
            <h3 class="text-xl font-black text-white uppercase italic tracking-tighter">Add Ad-Fuel</h3>
            <p class="text-zinc-500 text-[10px] font-black uppercase tracking-widest mt-1">Refuel your reach (1:3)</p>
        </div>
        <div class="space-y-4">
            <input type="number" id="boost-modal-input" class="w-full bg-white/5 border border-white/10 rounded-2xl py-4 text-center text-2xl font-black text-white outline-none focus:border-blue-500" value="100" oninput="document.getElementById('boost-modal-slider').value = this.value">
            <input type="range" id="boost-modal-slider" min="10" max="5000" step="10" class="w-full accent-blue-500" oninput="document.getElementById('boost-modal-input').value = this.value">
        </div>
        <div class="flex gap-3">
            <button onclick="closeBoostModal()" class="flex-1 py-4 text-zinc-500 text-[10px] font-black uppercase tracking-widest">Cancel</button>
            <button id="confirm-boost-btn" class="flex-1 py-4 bg-blue-600 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-lg">Confirm Boost</button>
        </div>
    </div>
</div>

<div id="delete-modal" class="fixed inset-0 z-[300] hidden flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl">
    <div class="bg-zinc-900 border border-white/10 w-full max-w-sm rounded-[2.5rem] p-8 text-center animate-in zoom-in-95 duration-300">
        <div class="w-16 h-16 bg-red-500/10 text-red-500 rounded-full flex items-center justify-center mx-auto mb-6 text-2xl">üóëÔ∏è</div>
        <h3 class="text-xl font-black text-white uppercase italic tracking-tighter mb-2">Delete Campaign?</h3>
        <p class="text-zinc-500 text-[10px] font-black uppercase leading-relaxed mb-8">This will permanently remove your mission and exhaust all remaining ad budget.</p>
        <div class="flex gap-3">
            <button onclick="closeDeleteModal()" class="flex-1 py-4 text-zinc-500 text-[10px] font-black uppercase tracking-widest">Keep It</button>
            <button id="confirm-delete-btn" class="flex-1 py-4 bg-red-600 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest">Delete Forever</button>
        </div>
    </div>
</div>
<script src="https://www.paypal.com/sdk/js?client-id=AdgA3AUZB2ZRXP35bjUJ31sk4kPTYKDvLn-NrpzQtFH1SzipPFFSCncRMu2FW_1YmsfnNuJift92GNpK&currency=USD&vault=true"></script>
<script type="module" src="./firebase-config.js"></script>

<script type="module">
    // 1. Importing tools from Google
    import { 
        onAuthStateChanged, signInWithPopup, GoogleAuthProvider, 
        signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword 
    } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
    
    import { 
        ref, update, onValue, get, set, push 
    } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

    // 2. Importing the connection from your new file
    import { auth, db } from './firebase-config.js';

    // 3. YOUR IDS AND DATA KEPT EXACTLY AS THEY WERE:
    const PLAN_ID = 'P-47S21200XM2944742NFPLPEA';

    const presets = [
        "https://img.pikbest.com/origin/10/25/30/74apIkbEsT5qB.jpg!w700wp",
        "https://thumbs.dreamstime.com/b/cool-neon-party-wolf-headphones-black-background-colorful-illustration-music-theme-modern-portrait-bright-vibrant-385601082.jpg",
        "https://wallpapers.com/images/hd/gaming-profile-pictures-tt8bbzdcf6zibhoi.jpg"
    ];

    
// This version ONLY locks for Profile and Donation modals
const syncScrollLock = () => {
    const lockIds = ['profile-modal', 'modern-donate-modal', 'donation-success-modal'];
    const shouldLock = lockIds.some(id => {
        const el = document.getElementById(id);
        return el && !el.classList.contains('hidden');
    });
    document.body.style.overflow = shouldLock ? 'hidden' : '';
};

    // --- UTILS & THEME ---
    window.notify = (msg) => {
        const t = document.createElement('div');
        t.className = 'toast show'; t.innerText = msg;
        const box = document.getElementById('notify-box');
        if(box) box.appendChild(t);
        setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 400); }, 3000);
    };

    window.setTheme = (theme) => {
        document.body.className = theme;
        localStorage.setItem('user-theme', theme);
        document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.getElementById(`btn-${theme}`);
        if(activeBtn) activeBtn.classList.add('active');
    };
    setTheme(localStorage.getItem('user-theme') || 'theme-dark');

    // --- MODAL CONTROLS ---
    window.openAuthModal = () => document.getElementById('auth-modal').classList.remove('hidden');
    window.closeAuthModal = () => document.getElementById('auth-modal').classList.add('hidden');
    
    window.openProfile = () => {
        document.getElementById('profile-modal').classList.remove('hidden');
        document.body.classList.add('stop-scrolling');
    };

    window.closeProfile = () => {
        document.getElementById('profile-modal').classList.add('hidden');
        document.body.classList.remove('stop-scrolling');
    };

    window.openUpgradeModal = () => {
        document.getElementById('upgrade-modal').classList.remove('hidden');
        setTimeout(initPayPal, 100);
    };
    
    window.closeUpgradeModal = () => document.getElementById('upgrade-modal').classList.add('hidden');

    // --- TOKEN MODAL LOGIC ---
    window.openTokenModal = () => {
        document.getElementById('token-modal').classList.remove('hidden');
        // Using the same class for consistency
        document.body.classList.add('stop-scrolling'); 
    };

    window.closeTokenModal = () => {
        document.getElementById('token-modal').classList.add('hidden');
        document.body.classList.remove('stop-scrolling'); 
        document.getElementById('paypal-tokens-container').innerHTML = ''; 
    };

    window.selectPack = (btn, amount, tokens) => {
        document.querySelectorAll('.pack-option').forEach(el => el.classList.remove('border-amber-500', 'bg-amber-500/10'));
        btn.classList.add('border-amber-500', 'bg-amber-500/10');
        window.buyPack(amount, tokens);
    };


    // --- AUTH LOGIC ---
    window.authTab = 'login';
    window.setAuthTab = (tab) => {
        window.authTab = tab;
        document.getElementById('reg-name-field').classList.toggle('hidden', tab === 'login');
        document.getElementById('tab-login').className = tab === 'login' ? 'pb-2 text-xs font-black uppercase border-b-2 border-amber-500' : 'pb-2 text-xs font-black uppercase text-zinc-500';
        document.getElementById('tab-register').className = tab === 'register' ? 'pb-2 text-xs font-black uppercase border-b-2 border-amber-500' : 'pb-2 text-xs font-black uppercase text-zinc-500';
    };

    window.handleAuthSubmit = async () => {
        const email = document.getElementById('auth-email').value;
        const pass = document.getElementById('auth-pass').value;
        try {
            if (window.authTab === 'register') {
                const handle = document.getElementById('auth-username').value.trim();
                const res = await createUserWithEmailAndPassword(auth, email, pass);
                await set(ref(db, `users/${res.user.uid}`), { username: handle, tokens: 0, isPremium: false });
            } else { await signInWithEmailAndPassword(auth, email, pass); }
            closeAuthModal();
        } catch(e) { notify(e.message); }
    };
    window.triggerGoogle = () => signInWithPopup(auth, new GoogleAuthProvider()).then(closeAuthModal);
    window.handleLogout = () => signOut(auth).then(() => location.reload());

    // --- PROFILE & NAME CHANGE (WITH COOLDOWN) ---
    window.saveProfileChanges = async () => {
        const user = auth.currentUser;
        if(!user) return;
        const newName = document.getElementById('username-input').value.trim();
        const snap = await get(ref(db, `users/${user.uid}`));
        const data = snap.val() || {};
        let updates = {};

        if (window.tempAvatar) updates.avatar = window.tempAvatar;
        
        if (newName && newName !== data.username) {
            const now = Date.now();
            const oneWeek = 7 * 24 * 60 * 60 * 1000;
            let history = (data.nameChanges || []).filter(timestamp => (now - timestamp) < oneWeek);

            if (!data.isPremium && history.length >= 2) {
                return notify("Free users: Only 2 name changes per week!");
            }
            
            updates.username = newName;
            history.push(now);
            updates.nameChanges = history;
        }

        await update(ref(db, `users/${user.uid}`), updates);
        notify("Profile Updated!"); 
        closeProfile();
    };

    // --- PAYPAL ---
    function initPayPal() {
        const target = document.getElementById(`paypal-button-container-${PLAN_ID}`) || document.getElementById('paypal-button-container-PRO');
        if (!window.paypal || !target || target.hasChildNodes()) return;
        window.paypal.Buttons({
            style: { shape: 'pill', color: 'gold', layout: 'vertical', label: 'subscribe' },
            createSubscription: (data, actions) => {
                return actions.subscription.create({ plan_id: PLAN_ID, custom_id: auth.currentUser.uid });
            },
            onApprove: async (data) => {
                await update(ref(db, `users/${auth.currentUser.uid}`), { isPremium: true, tokens: 20 });
                notify("Welcome to PRO!"); 
                closeUpgradeModal();
            }
        }).render(target);
    }

    // --- AVATAR PRESET GRID ---
    const grid = document.getElementById('avatar-grid');
    if(grid) {
        presets.forEach(url => {
            const img = document.createElement('img');
            img.src = url;
            img.className = "avatar-option w-full aspect-square object-cover rounded-xl cursor-pointer border-2 border-transparent hover:border-amber-500/50 transition-all";
            img.onclick = () => { 
                window.tempAvatar = url; 
                document.getElementById('modal-preview-img').src = url;
                document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected', 'border-amber-500'));
                img.classList.add('selected', 'border-amber-500');
            };
            grid.appendChild(img);
        });
    }
// --- MASTER DATA SYNC (STABLE VERSION + SECURITY + PRO PREVIEW + BAN APPEAL) ---
onAuthStateChanged(auth, (user) => {
    if (user) {
        const isAdmin = user.uid === "4xEDAzSt5javvSnW5mws2Ma8i8n1";

        // 1. User Data Listener & UI Sync
        onValue(ref(db, `users/${user.uid}`), (s) => {
            const d = s.val() || {};

            // --- THE BAN GUARD (WITH GREEN APPEAL REDIRECT) ---
            if (d.banned) {
                document.body.innerHTML = `
                    <div class="h-screen bg-black flex flex-col items-center justify-center text-center p-6 font-sans">
                        <div class="p-8 border border-red-500/30 bg-red-500/5 rounded-[40px] max-w-sm">
                            <h1 class="text-red-600 text-5xl font-black mb-4 italic tracking-tighter">ACCESS REVOKED</h1>
                            <p class="text-zinc-500 text-[10px] uppercase tracking-[0.2em] font-bold mb-6">Security Protocol 403: UID Blacklisted</p>
                            <p class="text-white/80 text-xs font-medium leading-relaxed mb-8">
                                This account has been permanently suspended for platform abuse or reaching maximum security strikes.
                            </p>
                            <a href="/support" class="inline-block w-full py-4 px-6 bg-emerald-500 hover:bg-emerald-400 text-black font-black text-[11px] uppercase rounded-full transition-all transform hover:scale-105 no-underline">
                                Appeal Suspension
                            </a>
                            <p class="mt-4 text-[8px] text-zinc-600 uppercase font-bold tracking-widest">Case ID: ${user.uid.substring(0, 10)}</p>
                        </div>
                    </div>`;
                return;
            }

            const name = d.username || "User";
            const avatar = d.avatar || presets[0];

            // --- FIXED: HEADER & PROFILE & PRO MODAL PREVIEWS ---
            const hHandle = document.getElementById('header-handle');
            const hPfp = document.getElementById('header-pfp');
            const hInit = document.getElementById('header-initial');
            
            const uInput = document.getElementById('username-input');
            const mPreview = document.getElementById('modal-preview-img');
            const mInit = document.getElementById('modal-preview-initial'); 
            
            const proPfp = document.getElementById('pro-pfp-preview');      
            const proName = document.getElementById('pro-name-preview');

            // Update Header
            if(hHandle) hHandle.innerText = isAdmin ? `üëë @${name}` : `@${name}`;
            if(hPfp) { hPfp.src = avatar; hPfp.classList.remove('hidden'); }
            if(hInit) hInit.classList.add('hidden');

            // Update Profile Modal (Big Preview)
            if(uInput) uInput.value = name;
            if(mPreview) { 
                mPreview.src = avatar; 
                mPreview.classList.remove('hidden'); 
            }
            if(mInit) mInit.classList.add('hidden'); 
            
            // Update PRO/Upgrade Modal Preview
            if(proPfp) {
                proPfp.src = avatar;
                proPfp.classList.remove('hidden');
            }
            if(proName) proName.innerText = name;

            // Update Tokens
            const tokenElement = document.getElementById('token-count');
            if(tokenElement) {
                tokenElement.innerText = d.tokens || 0;
                if(isAdmin) tokenElement.classList.add('text-amber-500');
            }

            // --- GROK SECURITY: AUTO-FLAG LARGE BALANCES ---
            if(d.tokens > 10000) {
                window.logSecurityAction('WHALE_ACCOUNT_SYNC', { tokens: d.tokens, user: name });
            }

            // Update Premium/Verified Toggles
            const hVerified = document.getElementById('header-verified');
            const mgmtZone = document.getElementById('premium-management-zone');
            const upgradeNavBtn = document.querySelector('button[onclick="openUpgradeModal()"]');
            
            if(d.isPremium || isAdmin) {
                if(hVerified) hVerified.classList.remove('hidden');
                if(mgmtZone && d.isPremium) mgmtZone.classList.remove('hidden');
                if(upgradeNavBtn) upgradeNavBtn.classList.add('hidden');
            } else {
                if(hVerified) hVerified.classList.add('hidden');
                if(mgmtZone) mgmtZone.classList.add('hidden');
                if(upgradeNavBtn) upgradeNavBtn.classList.remove('hidden');
            }
        });

        // 2. Initial UI Visibility
        ['user-tools', 'token-bar'].forEach(id => document.getElementById(id)?.classList.remove('hidden'));
        document.getElementById('login-btn')?.classList.add('hidden');

        // 3. Community Loaders
        if (typeof setupPresence === 'function') setupPresence(user.uid);
        if (typeof loadUserFeed === 'function') loadUserFeed();
        if (typeof loadCampaigns === 'function') loadCampaigns();
        if (typeof switchView === 'function') switchView('campaigns');

        // 4. Payout Listener (History)
        onValue(ref(db, `payouts`), (snapshot) => {
            const allPayouts = snapshot.val() || {};
            const historyList = document.getElementById('payout-history-list');
            const historyContainer = document.getElementById('payout-history-container');
            if(historyList) historyList.innerHTML = '';

            let totalPaid = 0; let pendingCount = 0; let hasHistory = false;

            Object.values(allPayouts).filter(p => p.uid === user.uid).sort((a,b) => b.timestamp - a.timestamp).forEach(p => {
                hasHistory = true; 
                if (p.status === 'completed' || p.status === 'paid') totalPaid += (p.netAmount || 0);
                if (p.status === 'pending') pendingCount++;

                if(historyList) {
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center p-3 bg-white/5 rounded-xl border border-white/5 mb-2";
                    const statusColor = (p.status === 'completed' || p.status === 'paid') ? 'text-emerald-500' : 'text-amber-500';
                    div.innerHTML = `<div class="flex flex-col"><span class="text-[9px] font-black text-white uppercase">$${p.netAmount.toFixed(2)}</span><span class="text-[8px] text-zinc-500">${new Date(p.timestamp).toLocaleDateString()}</span></div><span class="text-[8px] font-black uppercase ${statusColor}">${p.status}</span>`;
                    historyList.appendChild(div);
                }
            });
            if(hasHistory && historyContainer) historyContainer.classList.remove('hidden');
            if(document.getElementById('total-withdrawn')) document.getElementById('total-withdrawn').innerText = `$${totalPaid.toFixed(2)}`;
            if(document.getElementById('pending-count')) document.getElementById('pending-count').innerText = pendingCount;
        });

        // --- 5. GROK SECURITY MONITOR (QUOTA OPTIMIZED) ---
        let actionCount = 0;
        window.logSecurityAction = async (actionType, metadata = {}) => {
            actionCount++;
            const isHighValue = (metadata.amount && metadata.amount > 1000) || (metadata.tokens && metadata.tokens > 5000);
            const isSpamming = actionCount > 15;

            if (isHighValue || isSpamming || actionType === 'ADMIN_ACTION') {
                try {
                    const idToken = await user.getIdToken();
                    await fetch('/api/security-audit', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            idToken, 
                            actionType, 
                            metadata, 
                            severity: isSpamming ? 'medium' : (isHighValue ? 'high' : 'info')
                        })
                    });
                    if(isSpamming) actionCount = 0; 
                } catch (e) { console.error("Grok Audit Fail"); }
            }
        };
    }
});



    window.checkPremiumAndUpload = async () => {
        const user = auth.currentUser;
        if (!user) return notify("Please login first");
        const snap = await get(ref(db, `users/${user.uid}/isPremium`));
        if (snap.val()) {
            document.getElementById('pfp-upload').click();
        } else {
            notify("PRO required for custom uploads!");
            closeProfile();
            openUpgradeModal();
        }
    };

    window.buyPack = (amount, tokens) => {
        const container = document.getElementById('paypal-tokens-container');
        container.innerHTML = ''; 

        window.paypal.Buttons({
            style: { shape: 'pill', color: 'gold', layout: 'vertical', label: 'pay' },
            createOrder: (data, actions) => {
                return actions.order.create({
                    intent: "CAPTURE",
                    purchase_units: [{
                        description: `${tokens} Token Pack`,
                        amount: { currency_code: "USD", value: amount.toString() },
                        custom_id: auth.currentUser.uid 
                    }]
                });
            },
            onApprove: async (data, actions) => {
                const details = await actions.order.capture();
                const userRef = ref(db, `users/${auth.currentUser.uid}`);
                const snap = await get(userRef);
                const currentTokens = snap.val()?.tokens || 0;
                
                await update(userRef, { tokens: currentTokens + tokens });
                notify(`Success! ${tokens} tokens added.`);
                closeTokenModal();
            },
            onError: (err) => {
                console.error("PayPal Error:", err);
                notify("Payment failed to initialize.");
            }
        }).render('#paypal-tokens-container');
    };

    lucide.createIcons();
// --- COMPLETE WITHDRAWAL LOGIC (MODAL VERIFIED + VAULT ROUTING) ---

const ADMIN_UID = "4xEDAzSt5javvSnW5mws2Ma8i8n1";

// Custom Admin Verification Modal Controller
window.requestAdminSecret = () => {
    return new Promise((resolve) => {
        const modal = document.getElementById('admin-verify-modal');
        const input = document.getElementById('admin-secret-field');
        const confirmBtn = document.getElementById('confirm-verify-btn');
        const cancelBtn = document.getElementById('cancel-verify-btn');
        
        modal.classList.remove('hidden');
        input.value = '';
        input.focus();

        const cleanup = (val) => {
            modal.classList.add('hidden');
            confirmBtn.onclick = null;
            cancelBtn.onclick = null;
            resolve(val);
        };

        confirmBtn.onclick = () => cleanup(input.value.trim());
        cancelBtn.onclick = () => cleanup(null);
    });
};

// Modal Controllers
window.showErrorModal = (msg) => {
    const msgEl = document.getElementById('error-modal-msg');
    if(msgEl) msgEl.innerText = msg;
    document.getElementById('error-modal').classList.remove('hidden');
    document.body.classList.add('stop-scrolling');
    if (window.lucide) lucide.createIcons();
};

window.closeErrorModal = () => {
    document.getElementById('error-modal').classList.add('hidden');
    document.body.classList.remove('stop-scrolling');
};

window.showWithdrawSuccess = (usdAmount) => {
    const usdEl = document.getElementById('payout-success-usd');
    if(usdEl) usdEl.innerText = `$${usdAmount.toFixed(2)}`;
    document.getElementById('withdraw-success-modal').classList.remove('hidden');
    document.body.classList.add('stop-scrolling');
    if (typeof confetti === 'function') confetti();
    if (window.lucide) lucide.createIcons();
};

window.closeWithdrawSuccess = () => {
    document.getElementById('withdraw-success-modal').classList.add('hidden');
    document.body.classList.remove('stop-scrolling');
};

window.openWithdrawModal = () => {
    document.getElementById('withdraw-modal').classList.remove('hidden');
    document.body.classList.add('stop-scrolling');
};

window.closeWithdrawModal = () => {
    document.getElementById('withdraw-modal').classList.add('hidden');
    document.body.classList.remove('stop-scrolling');
    document.getElementById('withdraw-amount').value = '';
    document.getElementById('withdraw-email').value = '';
};

// Real-time Math for UI
document.getElementById('withdraw-amount')?.addEventListener('input', (e) => {
    const tokens = parseInt(e.target.value) || 0;
    const gross = tokens / 10;
    const fee = gross * 0.15; 
    const net = gross - fee;

    const grossEl = document.getElementById('calc-gross');
    const feeEl = document.getElementById('calc-fee');
    const netEl = document.getElementById('calc-net');

    if(grossEl) grossEl.innerText = `$${gross.toFixed(2)}`;
    if(feeEl) feeEl.innerText = `-$${fee.toFixed(2)}`;
    if(netEl) netEl.innerText = `$${net.toFixed(2)}`;
});

window.handleWithdrawSubmit = async () => {
    const user = auth.currentUser;
    const emailEl = document.getElementById('withdraw-email');
    const amountEl = document.getElementById('withdraw-amount');
    
    const email = emailEl?.value?.trim();
    const amount = parseInt(amountEl?.value);
    const btn = document.querySelector('button[onclick="handleWithdrawSubmit()"]');

    if (!user) return;
    if (!email || !email.includes('@')) return showErrorModal("Invalid PayPal email");
    if (isNaN(amount) || amount < 50) return showErrorModal("Min 50 Tokens ($5.00)");

    // --- 1. NEAT ADMIN VERIFICATION ---
    let adminSecret = null;
    if (user.uid === ADMIN_UID) {
        adminSecret = await requestAdminSecret();
        if (!adminSecret) return; // Cancelled
    }

    if(btn) {
        btn.disabled = true;
        btn.innerText = "Processing...";
    }

    try {
        const idToken = await user.getIdToken(true);

        // --- 2. SEND TO VERCEL API ---
        const response = await fetch('/api/withdraw', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ idToken, email, amount, adminSecret })
        });

        const text = await response.text();
        let result = JSON.parse(text);

        if (!response.ok) throw new Error(result.error || "Withdrawal failed");

        // --- 3. SUCCESS UI FLOW ---
        closeWithdrawModal();
        showWithdrawSuccess(result.netAmount);

    } catch (e) { 
        console.error("Withdrawal Error:", e);
        showErrorModal(e.message); 
    } finally {
        if(btn) {
            btn.disabled = false;
            btn.innerText = "Confirm Payout";
        }
    }
};

// --- IMGUR UPLOAD HANDLER ---
document.getElementById('pfp-upload')?.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // Validation
    if (file.size > 2 * 1024 * 1024) return notify("Image too large (Max 2MB)");
    
    notify("Uploading to Imgur...");
    
    const formData = new FormData();
    formData.append('image', file);

    try {
        const response = await fetch('https://api.imgur.com/3/image', {
            method: 'POST',
            headers: { 
                Authorization: 'Client-ID 891e5bb4aa94282' 
            },
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            const link = data.data.link;
            window.tempAvatar = link; // Stores the URL for saveProfileChanges()
            document.getElementById('modal-preview-img').src = link;
            notify("Uploaded! Click 'Update Profile' to save.");
        } else {
            notify("Imgur upload failed. Check API limits.");
        }
    } catch (err) {
        notify("Network error during upload.");
        console.error(err);
    }
});
// --- 0. CONFIG & PRESETS ---
const communityPresets = [
    "https://api.dicebear.com/7.x/avataaars/svg?seed=Felix",
    "https://api.dicebear.com/7.x/avataaars/svg?seed=Aneka",
    "https://api.dicebear.com/7.x/avataaars/svg?seed=James"
];

let activeTarget = { id: null, type: null };

// --- 1. DYNAMIC SEARCH (CAMPAIGNS & USERS) ---
window.searchUser = () => {
    const query = document.getElementById('user-search-input')?.value.toLowerCase().replace('@', '').replace('#', '');
    
    // Search Campaigns (checks title, desc, tags, country)
    const campaignCards = document.querySelectorAll('#campaign-grid > div');
    campaignCards.forEach(card => {
        const text = card.innerText.toLowerCase();
        card.classList.toggle('hidden', !text.includes(query));
    });

    // Search Users
    const userCards = document.querySelectorAll('#user-feed-grid > div');
    userCards.forEach(card => {
        const handle = card.getAttribute('data-handle')?.toLowerCase() || "";
        const email = card.getAttribute('data-email')?.toLowerCase() || "";
        card.classList.toggle('hidden', !(handle.includes(query) || email.includes(query)));
    });
};

// --- 2. MODAL CONTROLS ---
window.closeDonateModal = () => {
    document.getElementById('modern-donate-modal')?.classList.add('hidden');
    document.body.classList.remove('stop-scrolling');
};

window.closeCreateModal = () => {
    document.getElementById('create-campaign-modal')?.classList.add('hidden');
    document.body.classList.remove('stop-scrolling');
};

document.getElementById('donate-input-amount')?.addEventListener('input', (e) => {
    const amount = parseInt(e.target.value) || 0;
    const net = Math.floor(amount * 0.7);
    const notice = document.getElementById('fee-notice');
    if(notice) {
        notice.innerText = amount > 0 ? `Recipient receives: ${net} (30% fee applied)` : '';
        notice.className = "text-[10px] font-bold text-pink-500 mt-2 italic";
    }
});


// --- 3. VIEW SWITCHER ---
window.switchView = (view) => {
    const campView = document.getElementById('view-campaigns');
    const commView = document.getElementById('view-community');
    const campBtn = document.getElementById('tab-campaigns');
    const commBtn = document.getElementById('tab-community');

    if (view === 'campaigns') {
        if(campBtn) campBtn.className = "px-6 py-2.5 rounded-xl text-[10px] font-black uppercase bg-amber-500 text-black shadow-lg";
        if(commBtn) commBtn.className = "px-6 py-2.5 rounded-xl text-[10px] font-black uppercase text-zinc-500 hover:text-white";
        campView?.classList.remove('hidden');
        commView?.classList.add('hidden');
    } else {
        if(commBtn) commBtn.className = "px-6 py-2.5 rounded-xl text-[10px] font-black uppercase bg-emerald-500 text-black shadow-lg";
        if(campBtn) campBtn.className = "px-6 py-2.5 rounded-xl text-[10px] font-black uppercase text-zinc-500 hover:text-white";
        commView?.classList.remove('hidden');
        campView?.classList.add('hidden');
    }
};
// --- 4. CAMPAIGN FEED (ENHANCED & STABLE) ---

let activeCampaignListeners = [];

// Helper for Real-time Countdown
const getRemainingTime = (deadline) => {
    const diff = deadline - Date.now();
    if (diff <= 0) return "EXPIRED";
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
    if (days > 0) return `${days}D ${hours}H LEFT`;
    return `${hours}H LEFT`;
};

const loadCampaigns = () => {
    const grid = document.getElementById('campaign-grid');
    if (!grid) return;

    // CLEANUP: Prevent memory stacking
    activeCampaignListeners.forEach(unsub => unsub());
    activeCampaignListeners = [];

    const campaignsRef = ref(db, 'campaigns');
    
    const unsubscribe = onValue(campaignsRef, (snapshot) => {
        const campaigns = snapshot.val();
        grid.innerHTML = ''; 
        
        if (!campaigns) {
            grid.innerHTML = `<div class="col-span-full py-20 text-center opacity-40 text-white text-[10px] font-black uppercase tracking-widest">No active missions available</div>`;
            return;
        }

        const now = Date.now();

        // SORT: Boosted first (based on 1:3 reach math), then newest
        const sortedKeys = Object.keys(campaigns).sort((a, b) => {
            const aReachUsed = campaigns[a].viewsActive || 0;
            const bReachUsed = campaigns[b].viewsActive || 0;
            const isABoosted = ((campaigns[a].tokensBudget || 0) * 3 > aReachUsed);
            const isBBoosted = ((campaigns[b].tokensBudget || 0) * 3 > bReachUsed);
            
            if (isABoosted && !isBBoosted) return -1;
            if (!isABoosted && isBBoosted) return 1;
            return campaigns[b].timestamp - campaigns[a].timestamp;
        });

        sortedKeys.forEach(id => {
            const c = campaigns[id];
            
            // FILTER: Public Only
            if (c.visibility === 'private') return;

            const totalReachAllowed = (c.tokensBudget || 0) * 3;
            const views = c.viewsActive || 0;
            const isCurrentlyBoosted = (totalReachAllowed > views);
            const isPro = c.creatorIsPremium || false;
            const progress = Math.min((c.raised / c.goal) * 100, 100);
            
            const card = document.createElement('div');
            // AI Purple theme if AI generated, Amber if Boosted, Pink if Pro
            card.className = `p-5 rounded-[32px] border relative flex flex-col gap-4 transition-all duration-500 hover:translate-y-[-4px] ${
                isCurrentlyBoosted ? 'border-amber-500 shadow-[0_0_25px_rgba(245,158,11,0.25)] bg-zinc-900 scale-[1.01]' : 
                c.isAiGenerated ? 'border-purple-500/30 bg-zinc-900/90 shadow-[0_10px_30px_rgba(168,85,247,0.1)]' :
                isPro ? 'border-pink-500/40 bg-zinc-900/90 shadow-[0_10px_30px_rgba(236,72,153,0.1)]' : 
                'border-white/5 bg-zinc-900/40'
            }`;

            card.innerHTML = `
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <div class="flex items-center gap-2 bg-black/40 px-3 py-1.5 rounded-full border border-white/5">
                            <div class="w-1.5 h-1.5 rounded-full ${now > (c.deadline - 3600000) ? 'bg-orange-500 animate-pulse' : 'bg-emerald-500'}"></div>
                            <span class="text-[9px] font-black text-white uppercase countdown-timer" data-deadline="${c.deadline}">
                                ${getRemainingTime(c.deadline)}
                            </span>
                        </div>
                        ${isCurrentlyBoosted ? '<span class="bg-amber-500 text-black text-[7px] font-black px-2 py-0.5 rounded-full shadow-[0_0_10px_#f59e0b]">‚ö° BOOSTED</span>' : ''}
                    </div>
                    <span class="text-[9px] font-black text-zinc-500 uppercase tracking-widest">${c.category || 'Global'}</span>
                </div>

                <div class="flex gap-4 items-start">
                    <div class="w-16 h-16 rounded-2xl bg-zinc-800 flex-shrink-0 border border-white/10 overflow-hidden shadow-2xl relative">
                        <img src="${c.imageUrl}" class="w-full h-full object-cover">
                        ${c.isAiGenerated ? '<div class="absolute inset-0 bg-purple-500/10 mix-blend-overlay"></div>' : ''}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <h3 class="text-sm font-black uppercase text-white truncate tracking-tight">${c.title}</h3>
                            ${c.isAiGenerated ? '<span class="text-[7px] bg-purple-500/20 text-purple-400 px-1.5 py-0.5 rounded-md font-black uppercase border border-purple-500/30">‚ú® AI</span>' : ''}
                        </div>
                        <div class="text-[11px] text-zinc-400 leading-snug">
                            <span id="desc-short-${id}">${formatCampaignText(c.description || '', 85)}</span>
                            <span id="desc-full-${id}" class="hidden">${formatCampaignText(c.description || '')}</span>
                            ${c.description?.length > 85 ? `<button onclick="toggleDesc('${id}')" id="btn-${id}" class="text-blue-500 font-bold ml-1 hover:underline">Read More</button>` : ''}
                        </div>
                    </div>
                </div>

                <div class="bg-black/30 p-3 rounded-2xl border border-white/5">
                    <div class="flex justify-between text-[10px] font-black mb-2 px-1 uppercase">
                        <span class="text-emerald-400">$${Number(c.raised || 0).toLocaleString()} <span class="text-zinc-600 text-[8px] ml-1">Raised</span></span>
                        <span class="text-zinc-400">$${Number(c.goal || 0).toLocaleString()} <span class="text-zinc-600 text-[8px] ml-1">Goal</span></span>
                    </div>
                    <div class="w-full h-2 bg-white/10 rounded-full overflow-hidden">
                        <div class="h-full bg-gradient-to-r from-emerald-500 to-cyan-500 shadow-[0_0_10px_#10b981]" style="width: ${progress}%"></div>
                    </div>
                </div>

                <div class="flex items-center justify-between border-t border-white/5 pt-3 mt-auto">
                    <div class="flex items-center gap-3">
                        <button onclick="viewCreatorProfile('${c.creator}')" class="group flex items-center gap-2">
                            <div class="relative">
                                <img src="${c.creatorAvatar || 'https://img.icons8.com/fluency/48/user-male-circle.png'}" class="w-6 h-6 rounded-full object-cover border border-white/10 group-hover:border-blue-500 transition-all">
                                ${isPro ? '<img src="https://img.icons8.com/color/48/verified-badge.png" class="absolute -right-1 -bottom-1 w-3 h-3 bg-zinc-900 rounded-full">' : ''}
                            </div>
                            <span class="text-[9px] font-black text-zinc-500 group-hover:text-white uppercase">@${c.creatorName || 'Member'}</span>
                        </button>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="shareMission('${id}', '${c.title.replace(/'/g, "\\'")}')" class="p-2.5 bg-white/5 hover:bg-white/10 rounded-xl transition-all border border-white/5 active:scale-90">
                            <img src="https://img.icons8.com/material-outlined/24/ffffff/share.png" class="w-3.5 h-3.5 opacity-70">
                        </button>
                        <button onclick="handleDonateCampaign('${id}', '${c.title.replace(/'/g, "\\'")}')" class="px-5 py-2.5 bg-white text-black rounded-xl text-[10px] font-black uppercase hover:bg-blue-600 hover:text-white transition-all shadow-xl active:scale-95">Donate</button>
                    </div>
                </div>
            `;
            grid.appendChild(card);
            if(window.loadDonors) loadDonors(id);
        });
    });
    activeCampaignListeners.push(unsubscribe);
};

// --- SUPPORTING UTILITIES ---

window.shareMission = (id, title) => {
    const shareUrl = `${window.location.origin}/donate?id=${id}`;
    if (navigator.share) {
        navigator.share({ title: title, url: shareUrl }).catch(() => copyLink(shareUrl));
    } else {
        copyLink(shareUrl);
    }
};

const copyLink = (url) => {
    navigator.clipboard.writeText(url);
    notify("Mission link copied to clipboard!");
};

function formatCampaignText(text, limit = null) {
    if (!text) return "";
    let clean = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" class="text-pink-500 hover:underline">$1</a>')
                    .replace(/#(\w+)/g, '<span class="text-amber-500">#$1</span>');
    if (limit && text.length > limit) return clean.substring(0, limit) + "...";
    return clean;
}

window.toggleDesc = (id) => {
    const s = document.getElementById(`desc-short-${id}`);
    const f = document.getElementById(`desc-full-${id}`);
    const b = document.getElementById(`btn-${id}`);
    const isHidden = f.classList.contains('hidden');
    f.classList.toggle('hidden', !isHidden);
    s.classList.toggle('hidden', isHidden);
    b.innerText = isHidden ? "Less" : "Read More";
};

const loadDonors = (campaignId) => {
    onValue(ref(db, `campaign_donors/${campaignId}`), (snap) => {
        const container = document.getElementById(`donors-${campaignId}`);
        if(!container) return;
        container.innerHTML = '';
        const data = snap.val();
        if(!data) return;
        Object.values(data).slice(0, 3).forEach(d => {
            container.innerHTML += `<img src="${d.avatar || 'https://img.icons8.com/fluency/48/user-male-circle.png'}" class="w-5 h-5 rounded-full border-2 border-zinc-900 -ml-1.5 first:ml-0">`;
        });
    }, { onlyOnce: true });
};

// TIMER LOOP
setInterval(() => {
    document.querySelectorAll('.countdown-timer').forEach(el => {
        const deadline = parseInt(el.getAttribute('data-deadline'));
        const diff = deadline - Date.now();
        if (diff <= 0) { el.innerText = "ENDED"; el.className = "text-[9px] font-black text-red-500 uppercase"; return; }
        const h = Math.floor(diff / 3600000);
        const m = Math.floor((diff % 3600000) / 60000);
        const s = Math.floor((diff % 60000) / 1000);
        el.innerText = `${h}H ${m}M ${s}S`;
    });
}, 1000);

// --- 5. USER FEED ---
const loadUserFeed = () => {
    const feedGrid = document.getElementById('user-feed-grid');
    if (!feedGrid) return;

    onValue(ref(db, 'users'), (snapshot) => {
        const users = snapshot.val();
        feedGrid.innerHTML = '';
        if (!users) return;
        
        Object.keys(users).forEach(uid => {
            const u = users[uid];
            const isPro = u.isPremium || false;

            const card = document.createElement('div');
            card.setAttribute('data-handle', u.username || "");
            card.setAttribute('data-email', u.email || "");
            card.className = `p-5 rounded-[24px] border relative transition-all ${isPro ? 'border-pink-500/30 bg-white/5' : 'border-white/5 bg-zinc-900/40'}`;
            
            card.innerHTML = `
                <div class="flex items-start gap-4">
                    <div onclick="viewCreatorProfile('${uid}')" class="w-12 h-12 rounded-full border-2 ${isPro ? 'border-pink-500' : 'border-zinc-800'} p-0.5 overflow-hidden cursor-pointer">
                        <img src="${u.avatar || communityPresets[0]}" class="w-full h-full object-cover rounded-full">
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-center">
                            <span class="font-black text-xs text-white uppercase italic">@${u.username}</span>
                            <span class="text-xs">${u.mood === 'happy' ? 'üòä' : u.mood === 'sad' ? 'üòî' : 'üòê'}</span>
                        </div>
                        <p class="text-[9px] text-zinc-400 mt-1 italic line-clamp-2">${u.bio || 'Sharing the energy!'}</p>
                        <div class="flex items-center gap-2 mt-2">
                             <span class="text-[8px] bg-white/5 px-2 py-0.5 rounded text-zinc-500 font-bold uppercase">${u.country || 'Global'}</span>
                        </div>
                    </div>
                </div>
                <button onclick="handleTip('${uid}', '${u.username}', '${u.avatar}')" class="w-full mt-4 py-2 bg-emerald-500 text-black text-[10px] font-black uppercase rounded-xl hover:bg-emerald-400 transition-all">Tip User</button>
            `;
            feedGrid.appendChild(card);
        });
    });
};

// --- 6. TIMER & PROFILE REDIRECT ---
const startCountdown = (id, deadline) => {
    const timerInterval = setInterval(() => {
        const el = document.getElementById(`timer-${id}`);
        if (!el) return clearInterval(timerInterval);
        const diff = deadline - Date.now();
        if (diff <= 0) {
            el.innerText = "ENDED";
            loadCampaigns(); // Trigger archive logic
            return clearInterval(timerInterval);
        }
        const d = Math.floor(diff / (1000 * 60 * 60 * 24));
        const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const s = Math.floor((diff % (1000 * 60)) / 1000);
        el.innerText = `${d}d ${h}h ${m}m ${s}s`;
    }, 1000);
};

window.viewCreatorProfile = async (targetUid) => {
    const user = auth.currentUser;
    if (!user) return notify("Login required");
    const snap = await get(ref(db, `users/${user.uid}`));
    if (snap.val()?.isPremium) {
        window.location.href = `profile.html?id=${targetUid}`;
    } else {
        notify("PRO required to view profiles!");
        if(window.openUpgradeModal) openUpgradeModal();
    }
};

// --- 7. TRANSACTIONS & DONOR LOGGING (API POWERED + MAX SECURITY) ---

window.closeSuccessModal = () => {
    document.getElementById('donation-success-modal').classList.add('hidden');
    document.body.classList.remove('stop-scrolling');
};

window.confirmDonation = async () => {
    const user = auth.currentUser;
    if (!user) return notify("Login required to donate!");

    const amountInput = document.getElementById('donate-input-amount');
    const amount = parseInt(amountInput.value);
    const btn = document.getElementById('confirm-donation-btn');
    
    // --- SECURITY CONFIG ---
    const ADMIN_UID = "4xEDAzSt5javvSnW5mws2Ma8i8n1";

    // Basic Validation
    if (!amount || amount <= 0) return notify("Enter a valid amount");
    if (amount < 1) return notify("Minimum donation is 1 token");

    // --- 1. ADMIN SECRET CHECK (AUTO-DETECTION) ---
    let adminSecret = null;
    if (user.uid === ADMIN_UID) {
        // Triggers the neat verification popup we created
        adminSecret = await requestAdminSecret();
        
        // If user closes modal or leaves empty, stop the donation
        if (!adminSecret) {
            return; 
        }
    }

    // UI Feedback: Lock the button
    btn.disabled = true;
    btn.innerText = "Verifying Transaction...";

    try {
        // --- STEP 1: GENERATE SECURE PASS (ID TOKEN) ---
        const idToken = await user.getIdToken(true);

        // --- STEP 2: CALL VERCEL SERVERLESS API ---
        const response = await fetch('/api/donate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                idToken,
                targetId: activeTarget.id,
                amount: amount,
                type: activeTarget.type, // 'user' or 'campaign'
                adminSecret: adminSecret  // Passed to verify against Vercel Env
            })
        });

        const result = await response.json();

        // --- STEP 3: HANDLE SERVER ERRORS ---
        if (!response.ok) {
            if (result.error && result.error.includes("BANNED")) {
                location.reload();
                return;
            }
            throw new Error(result.error || "Transaction failed");
        }

        // --- STEP 4: SUCCESS UI ---
        const netAmount = result.netSent;
        const feeAmount = amount - netAmount;

        document.getElementById('success-net-amount').innerText = netAmount;
        document.getElementById('success-gross-amount').innerText = amount;
        document.getElementById('success-fee-amount').innerText = feeAmount;
        
        closeDonateModal(); 
        document.getElementById('donation-success-modal').classList.remove('hidden'); 
        document.body.classList.add('stop-scrolling');
        
        // Celebrate!
        if(typeof confetti === 'function') confetti();
        amountInput.value = '';

    } catch (e) { 
        console.error("Donation Error:", e);
        showErrorModal(e.message);
    } finally {
        btn.disabled = false;
        btn.innerText = "Confirm Transfer";
    }
};

// --- 8. GLOBAL HANDLERS ---
window.handleTip = async (uid, username, avatar) => {
    activeTarget = { id: uid, type: 'user' };
    
    // 1. Basic UI Setup
    document.getElementById('donate-target-name-display').innerText = `@${username}`;
    document.getElementById('donate-target-img').src = avatar || communityPresets[0];
    document.getElementById('donate-input-amount').value = '';
    document.getElementById('fee-notice').innerText = '';

    try {
        // 2. Fetch Premium status and Stats
        const [viewerSnap, targetSnap] = await Promise.all([
            get(ref(db, `users/${auth.currentUser.uid}`)),
            get(ref(db, `users/${uid}`))
        ]);

        const viewerData = viewerSnap.val() || {};
        const targetData = targetSnap.val() || {};
        const isViewerPro = viewerData.isPremium || (auth.currentUser.uid === "4xEDAzSt5javvSnW5mws2Ma8i8n1");

        // 3. Populate Stats
        document.getElementById('stat-raised-val').innerText = targetData.totalRaised || 0;
        document.getElementById('stat-donors-val').innerText = targetData.donorCount || 0;

        // 4. Handle the Glassy Lock
        const lockOverlay = document.getElementById('stats-premium-lock');
        isViewerPro ? lockOverlay.classList.add('hidden') : lockOverlay.classList.remove('hidden');

    } catch (e) { console.error("Stats Error:", e); }

    document.getElementById('modern-donate-modal').classList.remove('hidden');
    document.body.classList.add('stop-scrolling');
    if (typeof lucide !== 'undefined') lucide.createIcons();
};

window.handleDonateCampaign = async (id, title) => {
    activeTarget = { id: id, type: 'campaign' };
    
    document.getElementById('donate-target-name-display').innerText = title;
    document.getElementById('donate-target-img').src = "https://img.icons8.com/fluency/96/charity.png";
    document.getElementById('donate-input-amount').value = '';
    document.getElementById('fee-notice').innerText = '';

    try {
        // 1. Fetch Premium status and Campaign stats
        const [viewerSnap, campSnap] = await Promise.all([
            get(ref(db, `users/${auth.currentUser.uid}`)),
            get(ref(db, `campaigns/${id}`))
        ]);

        const viewerData = viewerSnap.val() || {};
        const campData = campSnap.val() || {};
        const isViewerPro = viewerData.isPremium || (auth.currentUser.uid === "4xEDAzSt5javvSnW5mws2Ma8i8n1");

        // 2. Populate Stats (Matches user field names or uses campaign defaults)
        document.getElementById('stat-raised-val').innerText = campData.raised || 0;
        document.getElementById('stat-donors-val').innerText = campData.donorsCount || 0;

        // 3. Handle the Glassy Lock (Same logic as User Tipping)
        const lockOverlay = document.getElementById('stats-premium-lock');
        isViewerPro ? lockOverlay.classList.add('hidden') : lockOverlay.classList.remove('hidden');

    } catch (e) { console.error("Campaign Stats Error:", e); }

    document.getElementById('modern-donate-modal').classList.remove('hidden');
    document.body.classList.add('stop-scrolling');
    if (typeof lucide !== 'undefined') lucide.createIcons();
};


// --- 9. INITIALIZE ---
loadCampaigns();
loadUserFeed();
switchView('campaigns');

const cBtn = document.getElementById('confirm-donation-btn');
if(cBtn) cBtn.onclick = window.confirmDonation;
// --- 1. Global State & Config ---
let selectedCampaignImg = "https://images.hive.blog/p/NTy4GV6ooFRmaCXZ8UYgPhoud1kjiNX8QokLEZtbBKLuLWQ9yt7K3o4MTgeicR2JF9fLXTD4sRt27d8vG5aiRCoDjrf24e3CMD5msbfdUbX1MzSVDjCMsn17K2A775iLEM4LvckBAcG8CU92RjLTtvsDiS6HzSxeXpvTZjux?format=match&mode=fit";
const IMGUR_CLIENT_ID = '891e5bb4aa94282';
let contentIsAiFlag = false; 

// --- 2. Helper: Custom Studio Success Modal ---
const studioReport = (type, msg, customTitle = "Studio Success") => {
    if (type === 'success') {
        const modal = document.getElementById('studio-success-modal');
        const titleEl = document.getElementById('studio-success-title');
        const msgEl = document.getElementById('studio-success-msg');
        if (modal && titleEl && msgEl) {
            titleEl.innerText = customTitle;
            msgEl.innerText = msg;
            modal.classList.remove('hidden');
        } else { notify("‚úÖ " + msg); }
    } else {
        if(window.showErrorModal) { window.showErrorModal(msg); } 
        else { notify("‚ùå " + msg); }
    }
};

window.closeStudioSuccess = () => document.getElementById('studio-success-modal').classList.add('hidden');

// --- 3. UI Reset & Reach Math ---
window.resetStudioData = () => {
    ['cp-title', 'cp-desc', 'cp-goal', 'reach-input-manual', 'reach-slider'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = (id.includes('reach')) ? 0 : '';
    });
    selectedCampaignImg = "https://images.hive.blog/p/NTy4GV6ooFRmaCXZ8UYgPhoud1kjiNX8QokLEZtbBKLuLWQ9yt7K3o4MTgeicR2JF9fLXTD4sRt27d8vG5aiRCoDjrf24e3CMD5msbfdUbX1MzSVDjCMsn17K2A775iLEM4LvckBAcG8CU92RjLTtvsDiS6HzSxeXpvTZjux?format=match&mode=fit";
    const preview = document.getElementById('cp-preview-img');
    if(preview) {
        preview.src = selectedCampaignImg;
        preview.classList.remove('animate-pulse', 'blur-sm');
    }
    contentIsAiFlag = false; 
    window.updateReachMath(0);
};

window.updateReachMath = (val) => {
    const tokens = parseInt(val) || 0;
    const views = tokens * 3; 
    const slider = document.getElementById('reach-slider');
    const input = document.getElementById('reach-input-manual');
    if(slider) slider.value = tokens;
    if(input) input.value = tokens;
    
    document.getElementById('reach-display').innerHTML = `${views.toLocaleString()} <span class="text-xs text-zinc-500 font-black">Reach</span>`;
    document.getElementById('cost-display').innerHTML = `${tokens.toLocaleString()} <span class="text-xs text-zinc-500 font-black">Tokens</span>`;
};

// --- 4. AI & Image Handling (Imgur with Loading States) ---
window.uploadCampaignImage = async (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const previewImg = document.getElementById('cp-preview-img');
    const uploadBtn = document.getElementById('upload-trigger-btn');
    
    // UI Loading State Start
    if(uploadBtn) { uploadBtn.innerText = "üõ∞Ô∏è Processing..."; uploadBtn.disabled = true; }
    if(previewImg) {
        previewImg.classList.add('animate-pulse', 'blur-md', 'brightness-50');
    }

    const formData = new FormData();
    formData.append('image', file);

    try {
        const response = await fetch('https://api.imgur.com/3/image', {
            method: 'POST',
            headers: { Authorization: `Client-ID ${IMGUR_CLIENT_ID}` },
            body: formData
        });

        const data = await response.json();
        if (data.success) {
            selectedCampaignImg = data.data.link;
            
            // Create a temporary image object to detect when the link is ACTUALLY loaded
            const tempImg = new Image();
            tempImg.onload = () => {
                if(previewImg) {
                    previewImg.src = selectedCampaignImg;
                    previewImg.classList.remove('animate-pulse', 'blur-md', 'brightness-50');
                }
            };
            tempImg.src = selectedCampaignImg;
            // Success notification removed as requested
        } else {
            throw new Error("Imgur Reject");
        }
    } catch (err) {
        if(previewImg) previewImg.classList.remove('animate-pulse', 'blur-md', 'brightness-50');
        studioReport('error', "Upload failed. Image might be too large.");
    } finally {
        if(uploadBtn) { uploadBtn.innerText = "üì∏ Custom Upload"; uploadBtn.disabled = false; }
    }
};

window.generateAIContent = async () => {
    const title = document.getElementById('cp-title').value.trim();
    const descField = document.getElementById('cp-desc');
    const aiBtn = document.getElementById('ai-gen-btn');
    if (!title || title.length < 5) return studioReport('error', "Enter a heading first!");
    aiBtn.innerText = "‚ú® Thinking..."; aiBtn.disabled = true;

    try {
        const response = await fetch('/api/generate', { 
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ prompt: title }) 
        });
        const data = await response.json();
        if (data.text) {
            descField.value = data.text;
            contentIsAiFlag = true; 
            notify("‚ú® Description Generated!");
        }
    } catch (err) { studioReport('error', "AI Bridge failed."); }
    finally { aiBtn.innerText = "‚ú® AI Auto-Write"; aiBtn.disabled = false; }
};

window.selectPreset = (url, el) => {
    selectedCampaignImg = url;
    const preview = document.getElementById('cp-preview-img');
    if(preview) preview.src = url;
    document.querySelectorAll('.preset-option').forEach(img => img.classList.replace('border-blue-500', 'border-transparent'));
    el.classList.replace('border-transparent', 'border-blue-500');
};

// --- 5. Tab & Lifecycle ---
window.openCreateCampaignModal = () => {
    document.getElementById('campaign-studio-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    window.switchStudioTab('create');
};

window.closeStudio = () => {
    document.getElementById('campaign-studio-modal').classList.add('hidden');
    document.body.style.overflow = '';
    window.resetStudioData(); 
};

window.switchStudioTab = (tab) => {
    const createView = document.getElementById('studio-create-view');
    const manageView = document.getElementById('studio-manage-view');
    const createBtn = document.getElementById('tab-btn-create');
    const manageBtn = document.getElementById('tab-btn-manage');
    const activeClass = "px-10 py-4 rounded-xl text-[11px] font-black uppercase tracking-widest bg-blue-600 text-white transition-all";
    const idleClass = "px-10 py-4 rounded-xl text-[11px] font-black uppercase tracking-widest text-zinc-500 transition-all";

    if(tab === 'create') {
        if(createView) createView.classList.remove('hidden'); 
        if(manageView) manageView.classList.add('hidden');
        if(createBtn) createBtn.className = activeClass; 
        if(manageBtn) manageBtn.className = idleClass;
    } else {
        if(createView) createView.classList.add('hidden'); 
        if(manageView) manageView.classList.remove('hidden');
        if(manageBtn) manageBtn.className = activeClass; 
        if(createBtn) createBtn.className = idleClass;
        window.loadMyCampaigns(); 
    }
};

// --- 6. Premium Check & Creation ---
window.checkPremiumVisibility = async (el) => {
    const user = auth.currentUser;
    if (!user) return;
    try {
        const userSnap = await get(ref(db, `users/${user.uid}`));
        const isPremium = userSnap.val()?.isPremium || false;

        if (el.value === 'private' && !isPremium) {
            studioReport('error', "Private Campaigns are for Premium Members only!");
            el.value = 'public';
            document.getElementById('premium-lock-icon').innerHTML = '<span class="text-red-500 text-[10px]">üîí</span>';
        } else if (el.value === 'private' && isPremium) {
            document.getElementById('premium-lock-icon').innerHTML = '<span class="text-emerald-500 text-[10px]">üíé</span>';
        } else {
            document.getElementById('premium-lock-icon').innerHTML = '<span class="text-blue-500 text-[10px]">üåê</span>';
        }
    } catch(e) { console.error(e); }
};

window.createNewCampaign = async () => {
    const user = auth.currentUser;
    if (!user) return studioReport('error', "Login first");

    const title = document.getElementById('cp-title').value.trim();
    const desc = document.getElementById('cp-desc').value.trim();
    const goal = parseInt(document.getElementById('cp-goal').value);
    const boostBudget = parseInt(document.getElementById('reach-slider').value) || 0;
    
    const visibility = document.getElementById('cp-visibility')?.value || 'public';
    const durationDays = parseInt(document.getElementById('cp-duration')?.value) || 7; 

    if (!title || !desc || isNaN(goal)) return studioReport('error', "Fill all fields");

    try {
        const userRef = ref(db, `users/${user.uid}`);
        const userSnap = await get(userRef);
        const userData = userSnap.val();

        if ((userData?.tokens || 0) < boostBudget) throw new Error("Not enough tokens!");
        
        const newRef = push(ref(db, 'campaigns'));
        const now = Date.now();
        const deadline = now + (durationDays * 24 * 60 * 60 * 1000);

        await set(newRef, {
            id: newRef.key,
            creator: user.uid,
            creatorName: userData?.username || "Member",
            creatorAvatar: userData?.avatar || "", 
            creatorIsPremium: userData?.isPremium || false,
            title, description: desc, goal, raised: 0,
            imageUrl: selectedCampaignImg, 
            tokensBudget: boostBudget,
            viewsActive: 0,
            category: document.getElementById('cp-category')?.value || 'General',
            deadline: deadline,
            timestamp: now,
            visibility: visibility, 
            isAiGenerated: contentIsAiFlag, 
            status: 'active'
        });

        if (boostBudget > 0) {
            await update(userRef, { tokens: (userData.tokens || 0) - boostBudget });
        }

        window.closeStudio();
        studioReport('success', `Mission Live!`, "Launch Success");

    } catch (e) { studioReport('error', e.message); }
};

// --- 7. Management & Boost (Live 1:3 Math) ---
window.updateBoostLiveMath = (val) => {
    const tokens = parseInt(val) || 0;
    const views = tokens * 3;
    const display = document.getElementById('boost-live-reach');
    if(display) display.innerText = `${views.toLocaleString()} Views`;
};

window.loadMyCampaigns = () => {
    const user = auth.currentUser;
    if(!user) return;
    const container = document.getElementById('my-campaigns-list');
    onValue(ref(db, 'campaigns'), (snap) => {
        if(!container) return;
        container.innerHTML = '';
        const data = snap.val();
        if(!data) return;
        Object.values(data).filter(c => c.creator === user.uid).forEach(c => {
            const tokensLeft = Math.max(0, (c.tokensBudget || 0) - (c.viewsActive || 0));
            const div = document.createElement('div');
            div.className = "bg-white/5 border border-white/10 p-6 rounded-[32px] mb-4 space-y-4";
            div.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex items-center gap-3">
                        <img src="${c.imageUrl}" class="w-12 h-12 rounded-xl object-cover border border-white/10">
                        <div>
                            <h4 class="text-white font-black text-xs uppercase truncate w-32">${c.title}</h4>
                            <span class="text-[7px] font-black uppercase italic ${c.visibility === 'public' ? 'text-emerald-500' : 'text-amber-500'}">
                                ‚óè ${c.visibility || 'public'}
                            </span>
                        </div>
                    </div>
                    <button onclick="handleDeleteRequest('${c.id}')" class="text-red-500 p-2 hover:bg-red-500/10 rounded-full transition-all">‚úï</button>
                </div>
                <div class="bg-black/30 p-4 rounded-2xl">
                    <div class="flex justify-between text-[10px] font-black uppercase mb-2">
                        <span class="text-zinc-500">Reach Used: ${c.viewsActive || 0}</span>
                        <span class="text-blue-500">${(tokensLeft * 3).toLocaleString()} Reach Left</span>
                    </div>
                    <div class="w-full h-1 bg-white/5 rounded-full overflow-hidden">
                        <div class="h-full bg-blue-500" style="width: ${c.tokensBudget > 0 ? (tokensLeft/c.tokensBudget)*100 : 0}%"></div>
                    </div>
                </div>
                <button onclick="handleBoostRequest('${c.id}')" class="w-full py-3 bg-blue-600 hover:bg-blue-500 rounded-2xl text-[10px] font-black uppercase text-white shadow-lg transition-all active:scale-95">‚ö° Add Reach Boost</button>
            `;
            container.appendChild(div);
        });
    });
};

window.handleDeleteRequest = (id) => {
    const modal = document.getElementById('delete-modal');
    if(!modal) return;
    modal.classList.remove('hidden');
    document.getElementById('confirm-delete-btn').onclick = async () => {
        await set(ref(db, `campaigns/${id}`), null);
        modal.classList.add('hidden');
        studioReport('success', "Mission Terminated.", "Deleted");
    };
};

window.handleBoostRequest = (id) => {
    const modal = document.getElementById('boost-modal');
    if(!modal) return;
    const boostInput = document.getElementById('boost-modal-input');
    const boostLive = document.getElementById('boost-live-reach');
    if(boostInput) boostInput.value = '';
    if(boostLive) boostLive.innerText = '0 Views';
    
    modal.classList.remove('hidden');
    document.getElementById('confirm-boost-btn').onclick = async () => {
        const amount = parseInt(boostInput.value);
        if(!amount || amount <= 0) return studioReport('error', "Enter tokens");
        try {
            const userRef = ref(db, `users/${auth.currentUser.uid}`);
            const userSnap = await get(userRef);
            if(userSnap.val().tokens < amount) return studioReport('error', "Insufficient Tokens");
            const campRef = ref(db, `campaigns/${id}`);
            const cSnap = await get(campRef);
            await update(userRef, { tokens: userSnap.val().tokens - amount });
            await update(campRef, { tokensBudget: (cSnap.val().tokensBudget || 0) + amount });
            modal.classList.add('hidden');
            studioReport('success', "Reach Refueled!", "Boost Active");
        } catch(e) { studioReport('error', "Boost failed"); }
    };
};

window.closeDeleteModal = () => document.getElementById('delete-modal').classList.add('hidden');
window.closeBoostModal = () => document.getElementById('boost-modal').classList.add('hidden');

// --- CHAT STORAGE & API-BASED REDIRECT ENGINE ---
const CHAT_STORAGE_KEY = 'grok_chat_history';

// 1. Storage Logic
const saveMessage = (role, text) => {
    const history = JSON.parse(localStorage.getItem(CHAT_STORAGE_KEY) || '[]');
    history.push({ role, text, timestamp: Date.now() });
    localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(history));
};

const loadChatHistory = () => {
    const history = JSON.parse(localStorage.getItem(CHAT_STORAGE_KEY) || '[]');
    const oneDay = 24 * 60 * 60 * 1000;
    const now = Date.now();
    const validHistory = history.filter(msg => (now - msg.timestamp) < oneDay);
    
    localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(validHistory));
    
    if (validHistory.length > 0) {
        validHistory.forEach(msg => renderMessage(msg.role, msg.text));
    } else {
        window.triggerInitialPoll(); 
    }
};

// 2. UI Rendering
const renderMessage = (role, text) => {
    const container = document.getElementById('chat-messages');
    if (!container) return;
    const isUser = role === 'user';
    const html = isUser ? `
        <div class="flex justify-end gap-3 max-w-[90%] ml-auto animate-in fade-in slide-in-from-right-4 duration-300">
            <div class="bg-blue-600 p-4 rounded-2xl rounded-tr-none shadow-xl">
                <p class="text-[11px] text-white leading-relaxed font-medium">${text}</p>
            </div>
        </div>
    ` : `
        <div class="flex gap-4 max-w-[90%] animate-in fade-in slide-in-from-left-4 duration-300">
            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-blue-600/20 border border-blue-500/30 flex items-center justify-center">
                <span class="text-[10px] font-black text-blue-400">G</span>
            </div>
            <div class="bg-white/5 border border-white/5 p-4 rounded-2xl rounded-tl-none">
                <p class="text-[11px] text-zinc-300 leading-relaxed font-medium">${text}</p>
            </div>
        </div>`;
    container.insertAdjacentHTML('beforeend', html);
    container.scrollTop = container.scrollHeight;
};

window.appendMessage = (role, text) => {
    saveMessage(role, text);
    renderMessage(role, text);
};

// 3. Protocol Selection (Initial Poll)
window.triggerInitialPoll = () => {
    const container = document.getElementById('chat-messages');
    const pollHtml = `
        <div id="initial-poll" class="bg-zinc-900 border border-blue-500/30 p-6 rounded-[32px] my-4 animate-in zoom-in duration-500 text-center">
            <h3 class="text-[10px] font-black text-white uppercase mb-1 tracking-widest italic">Uplink Established</h3>
            <p class="text-[8px] text-zinc-500 uppercase mb-4 font-bold tracking-tighter">Choose your interaction protocol</p>
            <div class="flex flex-col gap-2">
                <button onclick="selectPath('ai')" class="w-full py-3 bg-blue-600 text-white text-[10px] font-black uppercase rounded-xl active:scale-95 transition-all">Chat with AI (Instant)</button>
                <button onclick="selectPath('human')" class="w-full py-3 bg-white/5 text-zinc-300 border border-white/10 text-[10px] font-black uppercase rounded-xl active:scale-95 transition-all">Request Human Agent</button>
            </div>
        </div>`;
    container.insertAdjacentHTML('beforeend', pollHtml);
    container.scrollTop = container.scrollHeight;
};

// 4. Redirect Logic (Communicates with API)
window.selectPath = async (choice) => {
    if (choice === 'ai') {
        document.getElementById('initial-poll')?.remove();
        window.appendMessage('bot', "Grok AI active. How can I help you today?");
    } else {
        // TELL API TO SETUP TICKET AND REDIRECT
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    action: 'INITIATE_HANDOFF',
                    userId: auth.currentUser?.uid,
                    username: document.getElementById('header-handle')?.innerText 
                })
            });
            const data = await response.json();
            if (data.redirect) window.location.href = data.redirect;
        } catch (e) {
            window.location.href = '/support'; // Fallback if API fails
        }
    }
};

// 5. Core Chat Send Function
window.sendChatMessage = async () => {
    const input = document.getElementById('chat-input');
    const msgContainer = document.getElementById('chat-messages');
    const btn = document.getElementById('chat-send-btn');
    const userText = input.value.trim();

    if (!userText) return;

    window.appendMessage('user', userText);
    input.value = '';
    btn.disabled = true;

    const tid = 'load-' + Date.now();
    msgContainer.insertAdjacentHTML('beforeend', `<div id="${tid}" class="flex gap-2 p-4 animate-pulse"><div class="w-1 h-1 bg-blue-500 rounded-full animate-bounce"></div></div>`);
    msgContainer.scrollTop = msgContainer.scrollHeight;

    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                prompt: userText,
                userId: auth.currentUser?.uid,
                username: document.getElementById('header-handle')?.innerText 
            })
        });

        const data = await response.json();
        document.getElementById(tid)?.remove();

        // If the AI triggers a handoff or provides a redirect URL
        if (data.redirect || data.text === "HANDOFF_REQUEST") {
            window.appendMessage('bot', "Transferring you to a human agent...");
            setTimeout(() => { window.location.href = data.redirect || '/support'; }, 1000);
        } else {
            window.appendMessage('bot', data.text);
        }
    } catch (e) {
        document.getElementById(tid)?.remove();
        renderMessage('bot', "Connection Error.");
    } finally {
        btn.disabled = false;
        msgContainer.scrollTop = msgContainer.scrollHeight;
    }
};

document.addEventListener('DOMContentLoaded', loadChatHistory);


// --- ATTACHING TO WINDOW FOR ONCLICK ACCESS ---
window.openSupportChat = () => {
    const el = document.getElementById('support-modal');
    if(el) {
        el.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        if(window.lucide) lucide.createIcons();
    }
};

window.closeSupportChat = () => {
    document.getElementById('support-modal').classList.add('hidden');
    document.body.style.overflow = '';
};

window.openExploreModal = () => {
    const el = document.getElementById('explore-modal');
    if(el) {
        el.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
};

window.openWalletModal = () => {
    const el = document.getElementById('wallet-modal');
    if(el) {
        el.classList.remove('hidden');
        // Sync balance from your header/main state
        const bal = document.getElementById('token-count')?.innerText || "0";
        const walletDisplay = document.getElementById('wallet-token-count');
        if(walletDisplay) walletDisplay.innerText = bal;
        
        document.body.style.overflow = 'hidden';
    }
};

window.openAccountModal = () => {
    const el = document.getElementById('account-modal');
    if(el) {
        el.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
};

// Standard close functions for the new modals
window.closeWalletModal = () => {
    document.getElementById('wallet-modal').classList.add('hidden');
    document.body.style.overflow = '';
};

window.closeAccountModal = () => {
    document.getElementById('account-modal').classList.add('hidden');
    document.body.style.overflow = '';
};

window.closeExploreModal = () => {
    document.getElementById('explore-modal').classList.add('hidden');
    document.body.style.overflow = '';
};
// Helper for Relative Time (1m ago, 2h ago)
const getRelativeTime = (ts) => {
    if (!ts) return "Recently";
    const ms = Date.now() - ts;
    const sec = Math.floor(ms / 1000);
    if (sec < 60) return "Just now";
    const min = Math.floor(sec / 60);
    if (min < 60) return `${min}m ago`;
    const hr = Math.floor(min / 60);
    if (hr < 24) return `${hr}h ago`;
    return `${Math.floor(hr / 24)}d ago`;
};

window.switchHubView = async (view) => {
    const container = document.getElementById('hub-content');
    
    // 1. Loading State
    container.innerHTML = `
        <div class="flex flex-col items-center justify-center py-20 opacity-40">
            <div class="w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-[8px] font-black uppercase tracking-widest text-blue-500">Syncing Network...</p>
        </div>`;

    try {
        if (view === 'live') {
            // --- LIVE DONATIONS MODE (Real-time Feed) ---
            // Assumes you have a 'donations' node in your DB
            const snap = await get(ref(db, 'donations')); 
            const logs = snap.val() || {};
            
            const sortedLogs = Object.entries(logs)
                .sort((a, b) => b[1].timestamp - a[1].timestamp)
                .slice(0, 20);

            if (sortedLogs.length === 0) {
                container.innerHTML = `<p class="text-center py-20 text-[10px] text-zinc-600 font-black uppercase">No recent signal detected</p>`;
                return;
            }

            container.innerHTML = '';
            sortedLogs.forEach(([id, tx]) => {
                container.insertAdjacentHTML('beforeend', `
                <div class="flex items-center gap-4 p-4 bg-white/5 border border-white/5 rounded-[28px] animate-in slide-in-from-bottom-2">
                    <div class="flex -space-x-3">
                        <img src="${tx.fromAvatar || presets[0]}" class="w-10 h-10 rounded-full border-2 border-black object-cover">
                        <img src="${tx.toAvatar || presets[1]}" class="w-10 h-10 rounded-full border-2 border-black object-cover">
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="text-[10px] font-black text-white uppercase truncate">
                            ${tx.fromName || 'User'} <span class="text-blue-500 mx-1">‚Üí</span> ${tx.toName || 'Mission'}
                        </h4>
                        <p class="text-[7px] text-zinc-500 font-bold uppercase tracking-widest mt-1">
                            ${getRelativeTime(tx.timestamp)} ‚Ä¢ ${tx.type || 'Contribution'}
                        </p>
                    </div>
                    <div class="text-right">
                        <span class="text-xs font-black text-emerald-400">+$${tx.amount}</span>
                    </div>
                </div>`);
            });

        } else {
            // --- LEADERBOARD MODE (Top 25) ---
            const sortKey = view === 'top-donors' ? 'totalDonated' : 'raised';
            const snapshot = await get(ref(db, 'users'));
            const allData = snapshot.val() || {};

            const sorted = Object.entries(allData)
                .sort((a, b) => (b[1][sortKey] || 0) - (a[1][sortKey] || 0))
                .slice(0, 25);

            container.innerHTML = '';
            sorted.forEach(([id, item], index) => {
                const rank = index + 1;
                const isFirst = rank === 1;
                
                container.insertAdjacentHTML('beforeend', `
                <div class="group flex items-center gap-4 p-4 rounded-[32px] transition-all duration-500 
                    ${isFirst ? 'bg-blue-600/10 border-2 border-blue-500 shadow-[0_0_30px_rgba(59,130,246,0.1)]' : 'bg-white/5 border border-white/5'}">
                    
                    <div class="w-8 text-center font-black italic ${rank <= 3 ? 'text-blue-500' : 'text-zinc-800'}">
                        ${rank.toString().padStart(2, '0')}
                    </div>

                    <div class="relative">
                        <img src="${item.avatar || presets[0]}" class="w-12 h-12 rounded-full object-cover border-2 border-white/10 shadow-2xl">
                        ${isFirst ? '<div class="absolute -top-2 -right-1 text-xs animate-bounce">üëë</div>' : ''}
                    </div>

                    <div class="flex-1 min-w-0">
                        <h4 class="text-[11px] font-black text-white uppercase truncate">${item.username || 'Ghost_Signal'}</h4>
                        <p class="text-[7px] text-zinc-500 font-bold uppercase tracking-widest mt-0.5">Network Node Verified</p>
                    </div>

                    <div class="text-right">
                        <span class="text-sm font-black text-white italic">${item[sortKey] || 0}</span>
                        <div class="flex items-center justify-end gap-1 mt-0.5">
                            <p class="text-[7px] text-zinc-600 font-black uppercase tracking-tighter">Tokens</p>
                            <div class="w-1 h-1 rounded-full bg-blue-500 ${isFirst ? 'animate-ping' : ''}"></div>
                        </div>
                    </div>
                </div>`);
            });

            // Sticky Personal Stats
            const user = auth.currentUser;
            if (user && allData[user.uid]) {
                renderStickyUserStats(allData[user.uid], sortKey);
            }
        }
    } catch (e) { 
        console.error("Hub Error:", e);
        container.innerHTML = `<p class="text-center text-red-500 text-[8px] uppercase font-black">Sync Failed</p>`;
    }
};

function renderStickyUserStats(data, sortKey) {
    let bar = document.getElementById('user-hub-status');
    if (!bar) {
        bar = document.createElement('div');
        bar.id = 'user-hub-status';
        document.getElementById('explore-modal').appendChild(bar);
    }

    bar.className = "sticky bottom-0 p-5 bg-black/90 border-t border-blue-500/20 mt-4 backdrop-blur-2xl animate-in slide-in-from-bottom-full";
    bar.innerHTML = `
        <div class="flex justify-between items-center max-w-2xl mx-auto">
            <div class="flex items-center gap-3">
                <div class="relative">
                    <img src="${data.avatar || presets[0]}" class="w-10 h-10 rounded-full object-cover border-2 border-blue-600">
                    <div class="absolute inset-0 rounded-full animate-pulse border border-blue-400"></div>
                </div>
                <div>
                    <p class="text-[10px] font-black text-white uppercase tracking-tight">@${data.username}</p>
                    <p class="text-[7px] text-blue-500 font-black uppercase tracking-[0.2em]">Personal Signal</p>
                </div>
            </div>
            <div class="text-right">
                <span class="text-xl font-black text-white italic">${data[sortKey] || 0}</span>
                <p class="text-[8px] text-zinc-600 font-black uppercase">My Volume</p>
            </div>
        </div>`;
}

</script>
</body>
</html>
